{% extends 'base.html' %}

{% block title %}–í—ã–¥–∞—á–∞ –±–ª—é–¥{% endblock %}

{% block content %}
<div class="page-top-spacing">
    <div class="page-header">
        <div class="serve-header">
            <h2 class="page-title">–í—ã–¥–∞—á–∞ –±–ª—é–¥</h2>
            <div class="serve-date-badge">
                <span class="serve-date-icon">üìÖ</span>
                <span>{{ now.strftime('%d.%m.%Y') if now else '–°–µ–≥–æ–¥–Ω—è' }}</span>
            </div>
        </div>
    </div>
</div>

<!-- Stats Summary -->
<div class="serve-stats-row">
    <div class="serve-stat-mini">
        <span class="serve-stat-mini-icon">üìä</span>
        <span class="serve-stat-mini-label">–í—Å–µ–≥–æ –≤—ã–¥–∞–Ω–æ:</span>
        <span class="serve-stat-mini-value" id="total-served">{{ served.breakfast_count + served.lunch_count }}</span>
    </div>
</div>

<!-- Counters Grid -->
<div class="serve-counters-grid">
    <!-- Breakfast Counter -->
    <div class="serve-counter-card serve-counter-breakfast">
        <div class="serve-counter-header">
            <div class="serve-counter-icon-wrapper breakfast-icon">
                <span class="serve-counter-emoji">‚òÄÔ∏è</span>
            </div>
            <div class="serve-counter-badge">–ó–∞–≤—Ç—Ä–∞–∫</div>
        </div>
        
        <div class="serve-counter-body">
            <div class="serve-counter-display">
                <span id="breakfast-count" class="serve-counter-number">{{ served.breakfast_count }}</span>
                <span class="serve-counter-unit">–ø–æ—Ä—Ü–∏–π</span>
            </div>
            <p class="serve-counter-subtitle">–≤—ã–¥–∞–Ω–æ —Å–µ–≥–æ–¥–Ω—è</p>
        </div>
        
        <div class="serve-counter-actions">
            <button onclick="serveMeal('breakfast', -1)" class="serve-btn serve-btn-minus">
                <span>‚àí</span>
            </button>
            <button onclick="serveMeal('breakfast', 1)" class="serve-btn serve-btn-plus breakfast-btn">
                <span>+1</span>
            </button>
            <button onclick="serveMeal('breakfast', 5)" class="serve-btn serve-btn-multi breakfast-btn-light">
                <span>+5</span>
            </button>
            <button onclick="serveMeal('breakfast', 10)" class="serve-btn serve-btn-multi breakfast-btn-lighter">
                <span>+10</span>
            </button>
        </div>
        
        <div class="serve-counter-footer">
            <div class="serve-time-info">
                <span class="serve-time-icon">üïê</span>
                <span>7:30 - 9:00</span>
            </div>
        </div>
    </div>

    <!-- Lunch Counter -->
    <div class="serve-counter-card serve-counter-lunch">
        <div class="serve-counter-header">
            <div class="serve-counter-icon-wrapper lunch-icon">
                <span class="serve-counter-emoji">üçΩÔ∏è</span>
            </div>
            <div class="serve-counter-badge">–û–±–µ–¥</div>
        </div>
        
        <div class="serve-counter-body">
            <div class="serve-counter-display">
                <span id="lunch-count" class="serve-counter-number">{{ served.lunch_count }}</span>
                <span class="serve-counter-unit">–ø–æ—Ä—Ü–∏–π</span>
            </div>
            <p class="serve-counter-subtitle">–≤—ã–¥–∞–Ω–æ —Å–µ–≥–æ–¥–Ω—è</p>
        </div>
        
        <div class="serve-counter-actions">
            <button onclick="serveMeal('lunch', -1)" class="serve-btn serve-btn-minus">
                <span>‚àí</span>
            </button>
            <button onclick="serveMeal('lunch', 1)" class="serve-btn serve-btn-plus lunch-btn">
                <span>+1</span>
            </button>
            <button onclick="serveMeal('lunch', 5)" class="serve-btn serve-btn-multi lunch-btn-light">
                <span>+5</span>
            </button>
            <button onclick="serveMeal('lunch', 10)" class="serve-btn serve-btn-multi lunch-btn-lighter">
                <span>+10</span>
            </button>
        </div>
        
        <div class="serve-counter-footer">
            <div class="serve-time-info">
                <span class="serve-time-icon">üïê</span>
                <span>12:00 - 14:00</span>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="serve-quick-actions">
    <button onclick="resetCounters()" class="serve-quick-btn serve-quick-reset">
        <span class="serve-quick-icon">üîÑ</span>
        <span>–°–±—Ä–æ—Å–∏—Ç—å —Å—á—ë—Ç—á–∏–∫–∏</span>
    </button>
    <a href="{{ url_for('cook_inventory') }}" class="serve-quick-btn serve-quick-inventory">
        <span class="serve-quick-icon">üì¶</span>
        <span>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Å—Ç–∞—Ç–∫–∏</span>
    </a>
</div>

<!-- Pending Orders Section -->
<div class="serve-orders-section">
    <div class="serve-orders-header">
        <div class="serve-orders-title">
            <span class="serve-orders-icon">üìã</span>
            <h3>–û–∂–∏–¥–∞—é—â–∏–µ –∑–∞–∫–∞–∑—ã</h3>
            {% if pending_orders %}
            <span class="serve-orders-count">{{ pending_orders|length }}</span>
            {% endif %}
        </div>
        {% if pending_orders %}
        <button onclick="confirmAllOrders()" class="serve-confirm-all-btn">
            <span>‚úì</span> –í—ã–¥–∞—Ç—å –≤—Å–µ
        </button>
        {% endif %}
    </div>
    
    <div class="serve-orders-body">
        {% if pending_orders %}
        <div class="serve-orders-list" id="pending-orders">
            {% for order in pending_orders %}
            <div class="serve-order-card" id="pending-order-{{ order.id }}">
                <div class="serve-order-left">
                    <div class="serve-order-avatar">
                        {{ order.user.name.split()[0][0] }}{{ order.user.name.split()[-1][0] if order.user.name.split()|length > 1 else '' }}
                    </div>
                    <div class="serve-order-info">
                        <div class="serve-order-name">{{ order.user.name }}</div>
                        <div class="serve-order-class">{{ order.user.student_class or '–ö–ª–∞—Å—Å –Ω–µ —É–∫–∞–∑–∞–Ω' }}</div>
                        <div class="serve-order-items">
                            {% for item in order.items %}
                            <span class="serve-order-item-tag">{{ item.name }}</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="serve-order-right">
                    <div class="serve-order-meta">
                        <span class="serve-order-time">{{ order.created_at.strftime('%H:%M') }}</span>
                        <span class="serve-order-type {% if order.meal_type == 'breakfast' %}type-breakfast{% else %}type-lunch{% endif %}">
                            {% if order.meal_type == 'breakfast' %}‚òÄÔ∏è{% else %}üçΩÔ∏è{% endif %}
                        </span>
                    </div>
                    <div class="serve-order-total">{{ order.total|int }} ‚ÇΩ</div>
                    <button onclick="confirmOrder({{ order.id }})" class="serve-order-confirm-btn">
                        <span>‚úì</span> –í—ã–¥–∞—Ç—å
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="serve-orders-empty">
            <div class="serve-empty-icon">‚úÖ</div>
            <p class="serve-empty-title">–í—Å–µ –∑–∞–∫–∞–∑—ã –≤—ã–¥–∞–Ω—ã!</p>
            <p class="serve-empty-subtitle">–ù–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Recent Activity -->
<div class="serve-activity-section">
    <div class="serve-activity-header">
        <span class="serve-activity-icon">üìù</span>
        <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
    </div>
    <div class="serve-activity-list" id="activity-log">
        <div class="serve-activity-item">
            <span class="activity-dot activity-dot-success"></span>
            <span class="activity-text">–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ</span>
            <span class="activity-time">—Å–µ–π—á–∞—Å</span>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function serveMeal(type, count) {
    fetch(`/api/serve/${type}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ count: count })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            document.getElementById('breakfast-count').textContent = data.breakfast;
            document.getElementById('lunch-count').textContent = data.lunch;
            document.getElementById('total-served').textContent = data.breakfast + data.lunch;
            
            // Add activity log
            addActivity(type === 'breakfast' ? '‚òÄÔ∏è –ó–∞–≤—Ç—Ä–∞–∫' : 'üçΩÔ∏è –û–±–µ–¥', count > 0 ? `+${count}` : count);
            
            if (count > 0) {
                showToast(`${type === 'breakfast' ? '–ó–∞–≤—Ç—Ä–∞–∫' : '–û–±–µ–¥'}: +${count}`, 'success');
            }
        }
    });
}

function confirmOrder(orderId) {
    fetch(`/api/order/${orderId}/confirm`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            const orderEl = document.getElementById(`pending-order-${orderId}`);
            const name = orderEl.querySelector('.serve-order-name').textContent;
            
            orderEl.style.animation = 'slideOutRight 0.3s ease forwards';
            setTimeout(() => {
                orderEl.remove();
                updateOrdersCount();
            }, 300);
            
            addActivity(`‚úÖ –ó–∞–∫–∞–∑ –≤—ã–¥–∞–Ω: ${name}`, '');
            showToast('–ó–∞–∫–∞–∑ –≤—ã–¥–∞–Ω', 'success');
        }
    });
}

function confirmAllOrders() {
    const orders = document.querySelectorAll('.serve-order-card');
    orders.forEach((order, index) => {
        const orderId = order.id.replace('pending-order-', '');
        setTimeout(() => {
            confirmOrder(orderId);
        }, index * 200);
    });
}

function resetCounters() {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å —Å—á—ë—Ç—á–∏–∫–∏?')) {
        // Reset both counters
        serveMeal('breakfast', -parseInt(document.getElementById('breakfast-count').textContent));
        serveMeal('lunch', -parseInt(document.getElementById('lunch-count').textContent));
        addActivity('üîÑ –°—á—ë—Ç—á–∏–∫–∏ —Å–±—Ä–æ—à–µ–Ω—ã', '');
    }
}

function updateOrdersCount() {
    const count = document.querySelectorAll('.serve-order-card').length;
    const countBadge = document.querySelector('.serve-orders-count');
    const confirmAllBtn = document.querySelector('.serve-confirm-all-btn');
    
    if (count === 0) {
        if (countBadge) countBadge.remove();
        if (confirmAllBtn) confirmAllBtn.remove();
        
        document.querySelector('.serve-orders-body').innerHTML = `
            <div class="serve-orders-empty">
                <div class="serve-empty-icon">‚úÖ</div>
                <p class="serve-empty-title">–í—Å–µ –∑–∞–∫–∞–∑—ã –≤—ã–¥–∞–Ω—ã!</p>
                <p class="serve-empty-subtitle">–ù–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</p>
            </div>
        `;
    } else if (countBadge) {
        countBadge.textContent = count;
    }
}

function addActivity(action, value) {
    const log = document.getElementById('activity-log');
    const now = new Date();
    const time = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
    
    const item = document.createElement('div');
    item.className = 'serve-activity-item';
    item.innerHTML = `
        <span class="activity-dot activity-dot-success"></span>
        <span class="activity-text">${action} ${value}</span>
        <span class="activity-time">${time}</span>
    `;
    
    log.insertBefore(item, log.firstChild);
    
    // Keep only last 10 items
    while (log.children.length > 10) {
        log.removeChild(log.lastChild);
    }
}
</script>
{% endblock %}
