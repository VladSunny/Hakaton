{% extends 'base.html' %}

{% block title %}–ó–∞—è–≤–∫–∏ –Ω–∞ –∑–∞–∫—É–ø–∫—É{% endblock %}

{% block content %}
<div class="page-top-spacing">
    <div class="page-header">
        <div class="purchase-header">
            <div class="purchase-header-left">
                <h2 class="page-title">–ó–∞—è–≤–∫–∏ –Ω–∞ –∑–∞–∫—É–ø–∫—É</h2>
                <p class="purchase-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤</p>
            </div>
            <button onclick="openNewRequestModal()" class="btn btn-primary">
                <span>‚ûï</span> –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞
            </button>
        </div>
    </div>
</div>

<!-- Stats Row -->
<div class="purchase-stats-row">
    <div class="purchase-stat">
        <span class="purchase-stat-icon">üìã</span>
        <span class="purchase-stat-value">{{ requests|selectattr('status', 'equalto', 'pending')|list|length }}</span>
        <span class="purchase-stat-label">–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</span>
    </div>
    <div class="purchase-stat purchase-stat-success">
        <span class="purchase-stat-icon">‚úÖ</span>
        <span class="purchase-stat-value">{{ requests|selectattr('status', 'equalto', 'approved')|list|length }}</span>
        <span class="purchase-stat-label">–û–¥–æ–±—Ä–µ–Ω–æ</span>
    </div>
    <div class="purchase-stat purchase-stat-danger">
        <span class="purchase-stat-icon">‚ùå</span>
        <span class="purchase-stat-value">{{ requests|selectattr('status', 'equalto', 'rejected')|list|length }}</span>
        <span class="purchase-stat-label">–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</span>
    </div>
</div>

<!-- Requests List -->
<div class="purchase-requests-section">
    <div class="purchase-section-header">
        <h3 class="purchase-section-title">
            <span>üìù</span> –í—Å–µ –∑–∞—è–≤–∫–∏
        </h3>
        <div class="purchase-filter">
            <button class="filter-btn active" onclick="filterRequests('all')">–í—Å–µ</button>
            <button class="filter-btn" onclick="filterRequests('pending')">–û–∂–∏–¥–∞—é—Ç</button>
            <button class="filter-btn" onclick="filterRequests('approved')">–û–¥–æ–±—Ä–µ–Ω—ã</button>
        </div>
    </div>
    
    {% if requests %}
    <div class="purchase-requests-list">
        {% for req in requests %}
        <div class="purchase-request-card" data-status="{{ req.status }}">
            <div class="purchase-request-left">
                <div class="purchase-request-icon">
                    {% if '–º–æ–ª–æ–∫' in req.product.name.lower() %}ü•õ
                    {% elif '—è–π—Ü' in req.product.name.lower() %}ü•ö
                    {% elif '–º—É–∫' in req.product.name.lower() %}üåæ
                    {% elif '—Å–∞—Ö–∞—Ä' in req.product.name.lower() %}üßÇ
                    {% elif '–º–∞—Å–ª' in req.product.name.lower() %}üßà
                    {% elif '–∫—É—Ä–∏—Ü–∞' in req.product.name.lower() %}üçó
                    {% elif '–∫–∞—Ä—Ç–æ—Ñ' in req.product.name.lower() %}ü•î
                    {% elif '–º–æ—Ä–∫–æ–≤' in req.product.name.lower() %}ü•ï
                    {% elif '—Ä—ã–±' in req.product.name.lower() %}üêü
                    {% elif '–º–∞–∫–∞—Ä–æ–Ω' in req.product.name.lower() %}üçù
                    {% else %}üì¶{% endif %}
                </div>
                <div class="purchase-request-info">
                    <h4 class="purchase-request-name">{{ req.product.name }}</h4>
                    <p class="purchase-request-meta">
                        <span class="purchase-request-qty">{{ req.quantity }} {{ req.product.unit }}</span>
                        <span class="purchase-request-date">{{ req.created_at.strftime('%d.%m.%Y') }}</span>
                    </p>
                    <p class="purchase-request-author">–ó–∞—è–≤–∏—Ç–µ–ª—å: {{ req.created_by }}</p>
                </div>
            </div>
            <div class="purchase-request-right">
                <span class="purchase-status-badge {% if req.status == 'pending' %}status-pending{% elif req.status == 'approved' %}status-approved{% else %}status-rejected{% endif %}">
                    {% if req.status == 'pending' %}
                    <span>‚è≥</span> –ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏
                    {% elif req.status == 'approved' %}
                    <span>‚úÖ</span> –û–¥–æ–±—Ä–µ–Ω–æ
                    {% else %}
                    <span>‚ùå</span> –û—Ç–∫–ª–æ–Ω–µ–Ω–æ
                    {% endif %}
                </span>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="purchase-empty">
        <span class="purchase-empty-icon">üì≠</span>
        <h3>–ù–µ—Ç –∑–∞—è–≤–æ–∫</h3>
        <p>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞—è–≤–∫—É –Ω–∞ –∑–∞–∫—É–ø–∫—É</p>
        <button onclick="openNewRequestModal()" class="btn btn-primary">
            <span>‚ûï</span> –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É
        </button>
    </div>
    {% endif %}
</div>

<!-- Quick Products Section -->
<div class="purchase-quick-section">
    <div class="purchase-section-header">
        <h3 class="purchase-section-title">
            <span>‚ö°</span> –ë—ã—Å—Ç—Ä—ã–π –∑–∞–∫–∞–∑
        </h3>
    </div>
    <div class="purchase-quick-grid">
        {% for product in products %}
        {% set status = 'critical' if product.quantity <= product.min_quantity * 0.5 else ('low' if product.quantity <= product.min_quantity else 'ok') %}
        <div class="purchase-quick-card {% if status == 'critical' %}quick-critical{% elif status == 'low' %}quick-low{% endif %}"
             onclick="quickOrder({{ product.id }}, '{{ product.name }}', {{ product.min_quantity * 2 }}, '{{ product.unit }}')">
            <div class="quick-card-icon">
                {% if '–º–æ–ª–æ–∫' in product.name.lower() %}ü•õ
                {% elif '—è–π—Ü' in product.name.lower() %}ü•ö
                {% elif '–º—É–∫' in product.name.lower() %}üåæ
                {% elif '—Å–∞—Ö–∞—Ä' in product.name.lower() %}üßÇ
                {% elif '–º–∞—Å–ª' in product.name.lower() %}üßà
                {% elif '–∫—É—Ä–∏—Ü–∞' in product.name.lower() %}üçó
                {% elif '–∫–∞—Ä—Ç–æ—Ñ' in product.name.lower() %}ü•î
                {% elif '–º–æ—Ä–∫–æ–≤' in product.name.lower() %}ü•ï
                {% elif '—Ä—ã–±' in product.name.lower() %}üêü
                {% elif '–º–∞–∫–∞—Ä–æ–Ω' in product.name.lower() %}üçù
                {% else %}üì¶{% endif %}
            </div>
            <div class="quick-card-info">
                <span class="quick-card-name">{{ product.name }}</span>
                <span class="quick-card-stock">–û—Å—Ç–∞—Ç–æ–∫: {{ product.quantity }} {{ product.unit }}</span>
            </div>
            {% if status != 'ok' %}
            <span class="quick-card-badge">!</span>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>

<!-- New Request Modal -->
<div id="new-request-modal" class="modal-overlay hidden">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –∑–∞–∫—É–ø–∫—É</h3>
            <button onclick="closeModal('new-request-modal')" class="modal-close">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="new-request-form">
                <div class="form-group">
                    <label class="form-label">–ü—Ä–æ–¥—É–∫—Ç</label>
                    <select id="new-request-product" class="form-select" onchange="updateProductUnit()">
                        {% for product in products %}
                        <option value="{{ product.id }}" data-unit="{{ product.unit }}" data-min="{{ product.min_quantity }}">
                            {{ product.name }} (–æ—Å—Ç–∞–ª–æ—Å—å: {{ product.quantity }} {{ product.unit }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                    <div class="simple-qty-input-wrapper">
                        <input type="number" id="new-request-qty" class="form-input" min="1" value="10" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ">
                        <span class="simple-qty-unit" id="new-request-unit">–ª</span>
                    </div>
                </div>
                
                <div class="new-request-actions">
                    <button onclick="closeModal('new-request-modal')" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                    <button onclick="createNewRequest()" class="btn btn-primary">
                        <span>üì§</span> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// –ü—Ä–æ–≤–µ—Ä—è–µ–º URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('product_id');
    const productName = urlParams.get('product_name');
    const quantity = urlParams.get('quantity');
    const autoOpen = urlParams.get('auto_open');
    
    if (autoOpen === '1' && productId) {
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        setTimeout(() => {
            openNewRequestModal();
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç
            const select = document.getElementById('new-request-product');
            select.value = productId;
            updateProductUnit();
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
            if (quantity) {
                document.getElementById('new-request-qty').value = quantity;
            }
            
            // –û—á–∏—â–∞–µ–º URL
            window.history.replaceState({}, document.title, window.location.pathname);
        }, 300);
    }
});

function openNewRequestModal() {
    openModal('new-request-modal');
    updateProductUnit();
}

function updateProductUnit() {
    const select = document.getElementById('new-request-product');
    const selectedOption = select.options[select.selectedIndex];
    const unit = selectedOption.dataset.unit;
    document.getElementById('new-request-unit').textContent = unit;
}

function createNewRequest() {
    const productId = document.getElementById('new-request-product').value;
    const qty = document.getElementById('new-request-qty').value;
    
    if (!qty || qty <= 0) {
        showToast('–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ', 'error');
        return;
    }
    
    fetch('/api/purchase-request', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ product_id: parseInt(productId), quantity: parseFloat(qty) })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            closeModal('new-request-modal');
            setTimeout(() => location.reload(), 500);
        } else {
            showToast(data.message || '–û—à–∏–±–∫–∞', 'error');
        }
    });
}

function quickOrder(productId, name, suggestedQty, unit) {
    openNewRequestModal();
    
    const select = document.getElementById('new-request-product');
    select.value = productId;
    updateProductUnit();
    
    document.getElementById('new-request-qty').value = suggestedQty;
}

function filterRequests(status) {
    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏
    document.querySelectorAll('.purchase-request-card').forEach(card => {
        if (status === 'all' || card.dataset.status === status) {
            card.style.display = '';
        } else {
            card.style.display = 'none';
        }
    });
}
</script>
{% endblock %}
