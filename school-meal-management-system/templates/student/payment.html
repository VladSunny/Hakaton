{% extends 'base.html' %}

{% block title %}–û–ø–ª–∞—Ç–∞{% endblock %}

{% block content %}
<div class="page-top-spacing">
    <div class="page-header">
        <h2 class="page-title">–û–ø–ª–∞—Ç–∞ –ø–∏—Ç–∞–Ω–∏—è</h2>
    </div>
</div>

<div class="payment-grid">
    <!-- Balance Card -->
    <div class="card">
        <div class="card-body">
            <!-- Balance Display -->
            <div class="balance-card-display">
                <div class="balance-icon-wrapper">
                    <span class="balance-icon">üí∞</span>
                </div>
                <div class="balance-info">
                    <p class="balance-label">–í–∞—à –±–∞–ª–∞–Ω—Å</p>
                    <p id="balance-display" class="balance-amount">{{ current_user.balance }} ‚ÇΩ</p>
                </div>
            </div>

            <!-- Divider -->
            <div class="payment-divider"></div>

            <!-- Top Up Section -->
            <div class="topup-section">
                <h3 class="payment-section-title">
                    <span class="payment-section-icon">üí≥</span>
                    –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å
                </h3>
                
                <div class="topup-buttons">
                    <button onclick="topUp(300)" class="topup-amount-btn">
                        <span class="topup-value">300</span>
                        <span class="topup-currency">‚ÇΩ</span>
                    </button>
                    <button onclick="topUp(500)" class="topup-amount-btn">
                        <span class="topup-value">500</span>
                        <span class="topup-currency">‚ÇΩ</span>
                    </button>
                    <button onclick="topUp(1000)" class="topup-amount-btn topup-popular">
                        <span class="topup-popular-badge">–ü–æ–ø—É–ª—è—Ä–Ω–æ–µ</span>
                        <span class="topup-value">1000</span>
                        <span class="topup-currency">‚ÇΩ</span>
                    </button>
                    <button onclick="topUp(2000)" class="topup-amount-btn">
                        <span class="topup-value">2000</span>
                        <span class="topup-currency">‚ÇΩ</span>
                    </button>
                </div>

                <div class="topup-custom-wrapper">
                    <div class="topup-custom-input-wrapper">
                        <span class="topup-input-icon">‚ÇΩ</span>
                        <input type="number" id="custom-amount" class="topup-custom-input" placeholder="–î—Ä—É–≥–∞—è —Å—É–º–º–∞">
                    </div>
                    <button onclick="topUp(parseInt(document.getElementById('custom-amount').value))" class="btn btn-primary topup-custom-btn">
                        –ü–æ–ø–æ–ª–Ω–∏—Ç—å
                    </button>
                </div>
            </div>

            <!-- Payment Methods -->
            <div class="payment-methods">
                <p class="payment-methods-title">–°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã</p>
                <div class="payment-methods-icons">
                    <span class="payment-method" title="–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞">üí≥</span>
                    <span class="payment-method" title="–°–ë–ü">üè¶</span>
                    <span class="payment-method" title="–ù–∞–ª–∏—á–Ω—ã–µ –≤ –∫–∞—Å—Å–µ">üíµ</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Subscriptions Card -->
    <div class="card">
        <div class="card-body">
            <h3 class="payment-section-title">
                <span class="payment-section-icon">üé´</span>
                –ê–±–æ–Ω–µ–º–µ–Ω—Ç—ã
            </h3>
            <p class="payment-section-subtitle">–í—ã–≥–æ–¥–Ω–µ–µ, —á–µ–º –ø–ª–∞—Ç–∏—Ç—å –∑–∞ –∫–∞–∂–¥—ã–π –ø—Ä–∏–µ–º –ø–∏—â–∏ –æ—Ç–¥–µ–ª—å–Ω–æ</p>

            <div class="subscriptions-list">
                <!-- Week Subscription -->
                <div onclick="buySubscription('week')" class="subscription-item">
                    <div class="subscription-icon-wrapper subscription-icon-week">
                        <span>üìÖ</span>
                    </div>
                    <div class="subscription-details">
                        <div class="subscription-header">
                            <h4 class="subscription-name">–ù–µ–¥–µ–ª—å–Ω—ã–π</h4>
                            <div class="subscription-badge">-15%</div>
                        </div>
                        <p class="subscription-description">5 –∑–∞–≤—Ç—Ä–∞–∫–æ–≤ + 5 –æ–±–µ–¥–æ–≤</p>
                        <div class="subscription-footer">
                            <span class="subscription-price">1 500 ‚ÇΩ</span>
                            <span class="subscription-old-price">1 750 ‚ÇΩ</span>
                        </div>
                    </div>
                    <span class="subscription-arrow">‚Üí</span>
                </div>

                <!-- Month Subscription -->
                <div onclick="buySubscription('month')" class="subscription-item subscription-popular">
                    <div class="subscription-popular-label">–õ—É—á—à–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</div>
                    <div class="subscription-icon-wrapper subscription-icon-month">
                        <span>üìÜ</span>
                    </div>
                    <div class="subscription-details">
                        <div class="subscription-header">
                            <h4 class="subscription-name">–ú–µ—Å—è—á–Ω—ã–π</h4>
                            <div class="subscription-badge subscription-badge-gold">-20%</div>
                        </div>
                        <p class="subscription-description">20 –∑–∞–≤—Ç—Ä–∞–∫–æ–≤ + 20 –æ–±–µ–¥–æ–≤</p>
                        <div class="subscription-footer">
                            <span class="subscription-price">5 500 ‚ÇΩ</span>
                            <span class="subscription-old-price">7 000 ‚ÇΩ</span>
                        </div>
                    </div>
                    <span class="subscription-arrow">‚Üí</span>
                </div>
            </div>

            {% if subscription %}
            <!-- Active Subscription -->
            <div class="active-subscription">
                <div class="active-subscription-header">
                    <span class="active-subscription-icon">‚úÖ</span>
                    <span class="active-subscription-title">–ê–∫—Ç–∏–≤–Ω—ã–π –∞–±–æ–Ω–µ–º–µ–Ω—Ç</span>
                </div>
                <div class="active-subscription-body">
                    <div class="active-subscription-type">
                        {% if subscription.sub_type == 'week' %}
                        <span class="active-subscription-emoji">üìÖ</span>
                        <span>–ù–µ–¥–µ–ª—å–Ω—ã–π</span>
                        {% else %}
                        <span class="active-subscription-emoji">üìÜ</span>
                        <span>–ú–µ—Å—è—á–Ω—ã–π</span>
                        {% endif %}
                    </div>
                    <div class="active-subscription-remaining">
                        <span class="remaining-count">{{ subscription.remaining_meals }}</span>
                        <span class="remaining-label">–ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏ –æ—Å—Ç–∞–ª–æ—Å—å</span>
                    </div>
                    <div class="active-subscription-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{ (subscription.remaining_meals / (10 if subscription.sub_type == 'week' else 40)) * 100 }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Benefits -->
            <div class="subscription-benefits">
                <h4 class="benefits-title">–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞</h4>
                <ul class="benefits-list">
                    <li class="benefit-item">
                        <span class="benefit-icon">üí∞</span>
                        <span>–≠–∫–æ–Ω–æ–º–∏—è –¥–æ 20% –Ω–∞ –ø–∏—Ç–∞–Ω–∏–∏</span>
                    </li>
                    <li class="benefit-item">
                        <span class="benefit-icon">‚ö°</span>
                        <span>–ë—ã—Å—Ç—Ä–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –±–µ–∑ –æ–ø–ª–∞—Ç—ã</span>
                    </li>
                    <li class="benefit-item">
                        <span class="benefit-icon">üìä</span>
                        <span>–ö–æ–Ω—Ç—Ä–æ–ª—å —Ä–∞—Å—Ö–æ–¥–æ–≤ –Ω–∞ –ø–∏—Ç–∞–Ω–∏–µ</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Transaction History -->
<div class="card transaction-history-card">
    <div class="card-body">
        <h3 class="payment-section-title">
            <span class="payment-section-icon">üìã</span>
            –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
        </h3>
        <div class="transaction-list">
            <div class="transaction-item">
                <div class="transaction-icon transaction-icon-income">‚Üì</div>
                <div class="transaction-details">
                    <span class="transaction-title">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</span>
                    <span class="transaction-date">–°–µ–≥–æ–¥–Ω—è, 10:30</span>
                </div>
                <span class="transaction-amount transaction-amount-positive">+500 ‚ÇΩ</span>
            </div>
            <div class="transaction-item">
                <div class="transaction-icon transaction-icon-expense">‚Üë</div>
                <div class="transaction-details">
                    <span class="transaction-title">–û–ø–ª–∞—Ç–∞ –æ–±–µ–¥–∞</span>
                    <span class="transaction-date">–í—á–µ—Ä–∞, 13:15</span>
                </div>
                <span class="transaction-amount transaction-amount-negative">-180 ‚ÇΩ</span>
            </div>
            <div class="transaction-item">
                <div class="transaction-icon transaction-icon-income">‚Üì</div>
                <div class="transaction-details">
                    <span class="transaction-title">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</span>
                    <span class="transaction-date">20.01.2025</span>
                </div>
                <span class="transaction-amount transaction-amount-positive">+1000 ‚ÇΩ</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function topUp(amount) {
    if (!amount || amount <= 0) {
        showToast('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É', 'error');
        return;
    }
    
    fetch('/api/topup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ amount: amount })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            document.getElementById('balance-display').textContent = data.new_balance + ' ‚ÇΩ';
            document.getElementById('custom-amount').value = '';
        } else {
            showToast(data.message, 'error');
        }
    });
}

function buySubscription(type) {
    fetch('/api/subscription', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ type: type })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            location.reload();
        } else {
            showToast(data.message, 'error');
        }
    });
}
</script>
{% endblock %}
