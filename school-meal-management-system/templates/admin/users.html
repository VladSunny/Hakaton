{% extends 'base.html' %}

{% block title %}–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏{% endblock %}

{% block content %}
<div class="page-top-spacing">
    <div class="page-header">
        <div class="users-header">
            <div class="users-header-left">
                <h2 class="page-title">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
                <p class="users-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ —Å–∏—Å—Ç–µ–º—ã</p>
            </div>
            <button onclick="openAddUserModal()" class="btn btn-primary">
                <span>‚ûï</span> –î–æ–±–∞–≤–∏—Ç—å
            </button>
        </div>
    </div>
</div>

<!-- Stats Row -->
<div class="users-stats-row">
    <div class="users-stat">
        <span class="users-stat-icon">üë•</span>
        <span class="users-stat-value">{{ users|length }}</span>
        <span class="users-stat-label">–í—Å–µ–≥–æ</span>
    </div>
    <div class="users-stat users-stat-students">
        <span class="users-stat-icon">üéì</span>
        <span class="users-stat-value">{{ users|selectattr('role', 'equalto', 'student')|list|length }}</span>
        <span class="users-stat-label">–£—á–µ–Ω–∏–∫–æ–≤</span>
    </div>
    <div class="users-stat users-stat-cooks">
        <span class="users-stat-icon">üë®‚Äçüç≥</span>
        <span class="users-stat-value">{{ users|selectattr('role', 'equalto', 'cook')|list|length }}</span>
        <span class="users-stat-label">–ü–æ–≤–∞—Ä–æ–≤</span>
    </div>
    <div class="users-stat users-stat-admins">
        <span class="users-stat-icon">üë®‚Äçüíº</span>
        <span class="users-stat-value">{{ users|selectattr('role', 'equalto', 'admin')|list|length }}</span>
        <span class="users-stat-label">–ê–¥–º–∏–Ω–æ–≤</span>
    </div>
</div>

<!-- Users List -->
<div class="users-list-container">
    <div class="users-list-header">
        <div class="users-list-title">
            <span>üìã</span>
            <h3>–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
        </div>
        <div class="users-filter">
            <button class="filter-btn active" onclick="filterUsers('all')">–í—Å–µ</button>
            <button class="filter-btn" onclick="filterUsers('student')">–£—á–µ–Ω–∏–∫–∏</button>
            <button class="filter-btn" onclick="filterUsers('cook')">–ü–æ–≤–∞—Ä–∞</button>
            <button class="filter-btn" onclick="filterUsers('admin')">–ê–¥–º–∏–Ω—ã</button>
        </div>
    </div>
    
    <div class="users-list">
        {% for user in users %}
        <div class="user-list-item" data-role="{{ user.role }}" data-user-id="{{ user.id }}">
            <div class="user-list-left">
                <div class="user-list-avatar">
                    {{ user.name.split()[0][0] }}{{ user.name.split()[-1][0] if user.name.split()|length > 1 else '' }}
                </div>
                <div class="user-list-info">
                    <span class="user-list-name">{{ user.name }}</span>
                    <span class="user-list-email">{{ user.email }}</span>
                    {% if user.student_class %}
                    <span class="user-list-class">–ö–ª–∞—Å—Å: {{ user.student_class }}</span>
                    {% endif %}
                </div>
            </div>
            <div class="user-list-right">
                <div class="user-list-meta">
                    <span class="user-role-badge role-{{ user.role }}">
                        {% if user.role == 'student' %}üéì –£—á–µ–Ω–∏–∫
                        {% elif user.role == 'cook' %}üë®‚Äçüç≥ –ü–æ–≤–∞—Ä
                        {% else %}üë®‚Äçüíº –ê–¥–º–∏–Ω{% endif %}
                    </span>
                    {% if user.balance is not none %}
                    <span class="user-list-balance">{{ user.balance|int }} ‚ÇΩ</span>
                    {% endif %}
                </div>
                <div class="user-list-actions">
                    <button class="user-action-btn user-action-edit" onclick="openEditUserModal({{ user.id }}, '{{ user.name }}', '{{ user.email }}', '{{ user.role }}', '{{ user.student_class or '' }}')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                        ‚úèÔ∏è
                    </button>
                    {% if user.id != current_user.id %}
                    <button class="user-action-btn user-action-delete" onclick="confirmDeleteUser({{ user.id }}, '{{ user.name }}')" title="–£–¥–∞–ª–∏—Ç—å">
                        üóëÔ∏è
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Add User Modal -->
<div id="add-user-modal" class="modal-overlay hidden">
    <div class="modal modal-compact">
        <div class="modal-header">
            <h3 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
            <button onclick="closeModal('add-user-modal')" class="modal-close">‚úï</button>
        </div>
        <div class="modal-body modal-body-compact">
            <div class="form-row">
                <div class="form-group form-group-compact">
                    <label class="form-label">–§–ò–û</label>
                    <input type="text" id="add-user-name" class="form-input" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω">
                </div>
                <div class="form-group form-group-compact">
                    <label class="form-label">Email</label>
                    <input type="email" id="add-user-email" class="form-input" placeholder="email@school.ru">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group form-group-compact">
                    <label class="form-label">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="add-user-password" class="form-input" placeholder="–ú–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤">
                </div>
                <div class="form-group form-group-compact">
                    <label class="form-label">–†–æ–ª—å</label>
                    <select id="add-user-role" class="form-select" onchange="toggleAddUserFields()">
                        <option value="student">üéì –£—á–µ–Ω–∏–∫</option>
                        <option value="cook">üë®‚Äçüç≥ –ü–æ–≤–∞—Ä</option>
                        <option value="admin">üë®‚Äçüíº –ê–¥–º–∏–Ω</option>
                    </select>
                </div>
            </div>
            <div class="form-group form-group-compact" id="add-user-class-group">
                <label class="form-label">–ö–ª–∞—Å—Å</label>
                <select id="add-user-class" class="form-select">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å</option>
                    {% for grade in range(5, 12) %}
                    <option value="{{ grade }}–ê">{{ grade }}–ê</option>
                    <option value="{{ grade }}–ë">{{ grade }}–ë</option>
                    {% endfor %}
                </select>
            </div>
            <div class="modal-actions">
                <button onclick="closeModal('add-user-modal')" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                <button onclick="createUser()" class="btn btn-primary">‚úì –°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div id="edit-user-modal" class="modal-overlay hidden">
    <div class="modal modal-compact">
        <div class="modal-header">
            <h3 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</h3>
            <button onclick="closeModal('edit-user-modal')" class="modal-close">‚úï</button>
        </div>
        <div class="modal-body modal-body-compact">
            <input type="hidden" id="edit-user-id">
            <div class="form-row">
                <div class="form-group form-group-compact">
                    <label class="form-label">–§–ò–û</label>
                    <input type="text" id="edit-user-name" class="form-input">
                </div>
                <div class="form-group form-group-compact">
                    <label class="form-label">Email</label>
                    <input type="email" id="edit-user-email" class="form-input">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group form-group-compact">
                    <label class="form-label">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                    <input type="password" id="edit-user-password" class="form-input" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º">
                </div>
                <div class="form-group form-group-compact">
                    <label class="form-label">–†–æ–ª—å</label>
                    <select id="edit-user-role" class="form-select" onchange="toggleEditUserFields()">
                        <option value="student">üéì –£—á–µ–Ω–∏–∫</option>
                        <option value="cook">üë®‚Äçüç≥ –ü–æ–≤–∞—Ä</option>
                        <option value="admin">üë®‚Äçüíº –ê–¥–º–∏–Ω</option>
                    </select>
                </div>
            </div>
            <div class="form-group form-group-compact" id="edit-user-class-group">
                <label class="form-label">–ö–ª–∞—Å—Å</label>
                <select id="edit-user-class" class="form-select">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å</option>
                    {% for grade in range(5, 12) %}
                    <option value="{{ grade }}–ê">{{ grade }}–ê</option>
                    <option value="{{ grade }}–ë">{{ grade }}–ë</option>
                    {% endfor %}
                </select>
            </div>
            <div class="modal-actions">
                <button onclick="closeModal('edit-user-modal')" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                <button onclick="updateUser()" class="btn btn-primary">‚úì –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-user-modal" class="modal-overlay hidden">
    <div class="modal modal-small">
        <div class="modal-header">
            <h3 class="modal-title">–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?</h3>
            <button onclick="closeModal('delete-user-modal')" class="modal-close">‚úï</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="delete-user-id">
            <div class="delete-warning">
                <span class="delete-warning-icon">‚ö†Ô∏è</span>
                <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è <strong id="delete-user-name"></strong>?</p>
                <p class="delete-warning-text">–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å. –í—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.</p>
            </div>
            <div class="modal-actions">
                <button onclick="closeModal('delete-user-modal')" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                <button onclick="deleteUser()" class="btn btn-danger">
                    <span>üóëÔ∏è</span> –£–¥–∞–ª–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Filter users
function filterUsers(role) {
    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    document.querySelectorAll('.user-list-item').forEach(item => {
        if (role === 'all' || item.dataset.role === role) {
            item.style.display = '';
        } else {
            item.style.display = 'none';
        }
    });
}

// Add User Modal
function openAddUserModal() {
    document.getElementById('add-user-name').value = '';
    document.getElementById('add-user-email').value = '';
    document.getElementById('add-user-password').value = '';
    document.getElementById('add-user-role').value = 'student';
    document.getElementById('add-user-class').value = '';
    document.getElementById('add-user-balance').value = '0';
    toggleAddUserFields();
    openModal('add-user-modal');
}

function toggleAddUserFields() {
    const role = document.getElementById('add-user-role').value;
    const classGroup = document.getElementById('add-user-class-group');
    
    if (role === 'student') {
        classGroup.style.display = '';
    } else {
        classGroup.style.display = 'none';
    }
}

function createUser() {
    const name = document.getElementById('add-user-name').value;
    const email = document.getElementById('add-user-email').value;
    const password = document.getElementById('add-user-password').value;
    const role = document.getElementById('add-user-role').value;
    const studentClass = document.getElementById('add-user-class').value;
    
    if (!name || !email || !password) {
        showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
        return;
    }
    
    if (password.length < 6) {
        showToast('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
        return;
    }
    
    fetch('/api/admin/user/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            name: name,
            email: email,
            password: password,
            role: role,
            student_class: studentClass
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            closeModal('add-user-modal');
            setTimeout(() => location.reload(), 500);
        } else {
            showToast(data.message, 'error');
        }
    });
}

// Edit User Modal
function openEditUserModal(id, name, email, role, studentClass) {
    document.getElementById('edit-user-id').value = id;
    document.getElementById('edit-user-name').value = name;
    document.getElementById('edit-user-email').value = email;
    document.getElementById('edit-user-password').value = '';
    document.getElementById('edit-user-role').value = role;
    document.getElementById('edit-user-class').value = studentClass;
    toggleEditUserFields();
    openModal('edit-user-modal');
}

function toggleEditUserFields() {
    const role = document.getElementById('edit-user-role').value;
    const classGroup = document.getElementById('edit-user-class-group');
    
    if (role === 'student') {
        classGroup.style.display = '';
    } else {
        classGroup.style.display = 'none';
    }
}

function updateUser() {
    const id = document.getElementById('edit-user-id').value;
    const name = document.getElementById('edit-user-name').value;
    const email = document.getElementById('edit-user-email').value;
    const password = document.getElementById('edit-user-password').value;
    const role = document.getElementById('edit-user-role').value;
    const studentClass = document.getElementById('edit-user-class').value;
    
    if (!name || !email) {
        showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
        return;
    }
    
    const data = {
        name: name,
        email: email,
        role: role,
        student_class: studentClass
    };
    
    if (password) {
        if (password.length < 6) {
            showToast('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
            return;
        }
        data.password = password;
    }
    
    fetch(`/api/admin/user/${id}/update`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            closeModal('edit-user-modal');
            setTimeout(() => location.reload(), 500);
        } else {
            showToast(data.message, 'error');
        }
    });
}

// Delete User
function confirmDeleteUser(id, name) {
    document.getElementById('delete-user-id').value = id;
    document.getElementById('delete-user-name').textContent = name;
    openModal('delete-user-modal');
}

function deleteUser() {
    const id = document.getElementById('delete-user-id').value;
    
    fetch(`/api/admin/user/${id}/delete`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            closeModal('delete-user-modal');
            document.querySelector(`[data-user-id="${id}"]`).remove();
        } else {
            showToast(data.message, 'error');
        }
    });
}
</script>
{% endblock %}
