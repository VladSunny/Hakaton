{% extends 'base.html' %}

{% block title %}–û—Ç—á—ë—Ç—ã{% endblock %}

{% block content %}
<div class="page-top-spacing">
    <div class="page-header">
        <div class="reports-header">
            <div class="reports-header-left">
                <h2 class="page-title">–û—Ç—á—ë—Ç—ã</h2>
                <p class="reports-subtitle">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —à–∫–æ–ª—å–Ω–æ–≥–æ –ø–∏—Ç–∞–Ω–∏—è</p>
            </div>
            <div class="reports-header-actions">
                <a href="{{ url_for('export_weekly_report') }}" class="btn btn-primary">
                    <span>üì•</span> –≠–∫—Å–ø–æ—Ä—Ç
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Key Metrics -->
<div class="reports-metrics-grid">
    <div class="reports-metric-card metric-revenue">
        <div class="metric-card-header">
            <div class="metric-icon-wrapper revenue-icon">
                <span>üí∞</span>
            </div>
        </div>
        <div class="metric-value">{{ total_revenue|int }} ‚ÇΩ</div>
        <div class="metric-label">–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞</div>
        <div class="metric-comparison">
            <span>–ó–∞ –Ω–µ–¥–µ–ª—é: {{ week_revenue|int }} ‚ÇΩ</span>
        </div>
    </div>

    <div class="reports-metric-card metric-orders">
        <div class="metric-card-header">
            <div class="metric-icon-wrapper orders-icon">
                <span>üõí</span>
            </div>
        </div>
        <div class="metric-value">{{ orders_count }}</div>
        <div class="metric-label">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
        <div class="metric-comparison">
            <span>–ü–æ–ª—É—á–µ–Ω–æ: {{ received_count }} | –û–∂–∏–¥–∞–µ—Ç: {{ pending_count }}</span>
        </div>
    </div>

    <div class="reports-metric-card metric-avg">
        <div class="metric-card-header">
            <div class="metric-icon-wrapper avg-icon">
                <span>üìä</span>
            </div>
        </div>
        <div class="metric-value">{{ avg_check|int }} ‚ÇΩ</div>
        <div class="metric-label">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫</div>
        <div class="metric-comparison">
            <span>{{ items_per_order }} –±–ª—é–¥ –Ω–∞ –∑–∞–∫–∞–∑</span>
        </div>
    </div>

    <div class="reports-metric-card metric-students">
        <div class="metric-card-header">
            <div class="metric-icon-wrapper students-icon">
                <span>üçΩÔ∏è</span>
            </div>
        </div>
        <div class="metric-value">{{ total_meals }}</div>
        <div class="metric-label">–í—Å–µ–≥–æ –ø–æ—Ä—Ü–∏–π</div>
        <div class="metric-comparison">
            <span>–ó–∞–≤—Ç—Ä–∞–∫–∏ + –û–±–µ–¥—ã</span>
        </div>
    </div>
</div>

<!-- Meal Statistics -->
<div class="reports-meals-section">
    <div class="reports-section-header">
        <div class="reports-section-title">
            <span class="section-icon">üçΩÔ∏è</span>
            <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∏–ø–∞–º –ø–∏—Ç–∞–Ω–∏—è</h3>
        </div>
    </div>
    
    <div class="meals-stats-grid">
        <div class="meal-stat-card breakfast-stat">
            <div class="meal-stat-visual">
                <div class="meal-stat-circle">
                    {% set breakfast_percent = (breakfast_count / total_meals * 100) if total_meals > 0 else 0 %}
                    <svg viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="45" fill="none" stroke="#fef3c7" stroke-width="10"/>
                        <circle cx="50" cy="50" r="45" fill="none" stroke="#f59e0b" stroke-width="10" 
                                stroke-dasharray="{{ breakfast_percent * 2.83 }} 283"
                                stroke-linecap="round" transform="rotate(-90 50 50)"/>
                    </svg>
                    <div class="meal-stat-circle-content">
                        <span class="meal-stat-emoji">‚òÄÔ∏è</span>
                    </div>
                </div>
            </div>
            <div class="meal-stat-info">
                <div class="meal-stat-value">{{ breakfast_count }}</div>
                <div class="meal-stat-label">–ó–∞–≤—Ç—Ä–∞–∫–æ–≤</div>
                <div class="meal-stat-percent">{{ breakfast_percent|int }}% –æ—Ç –æ–±—â–µ–≥–æ</div>
            </div>
            <div class="meal-stat-details">
                <div class="meal-detail-item">
                    <span class="detail-label">–í—ã—Ä—É—á–∫–∞:</span>
                    <span class="detail-value">{{ breakfast_revenue|int }} ‚ÇΩ</span>
                </div>
                <div class="meal-detail-item">
                    <span class="detail-label">–°—Ä. —Ü–µ–Ω–∞:</span>
                    <span class="detail-value">{{ avg_breakfast_price|int }} ‚ÇΩ</span>
                </div>
            </div>
        </div>

        <div class="meal-stat-card lunch-stat">
            <div class="meal-stat-visual">
                <div class="meal-stat-circle">
                    {% set lunch_percent = (lunch_count / total_meals * 100) if total_meals > 0 else 0 %}
                    <svg viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="45" fill="none" stroke="#ffedd5" stroke-width="10"/>
                        <circle cx="50" cy="50" r="45" fill="none" stroke="#f97316" stroke-width="10" 
                                stroke-dasharray="{{ lunch_percent * 2.83 }} 283"
                                stroke-linecap="round" transform="rotate(-90 50 50)"/>
                    </svg>
                    <div class="meal-stat-circle-content">
                        <span class="meal-stat-emoji">üçΩÔ∏è</span>
                    </div>
                </div>
            </div>
            <div class="meal-stat-info">
                <div class="meal-stat-value">{{ lunch_count }}</div>
                <div class="meal-stat-label">–û–±–µ–¥–æ–≤</div>
                <div class="meal-stat-percent">{{ lunch_percent|int }}% –æ—Ç –æ–±—â–µ–≥–æ</div>
            </div>
            <div class="meal-stat-details">
                <div class="meal-detail-item">
                    <span class="detail-label">–í—ã—Ä—É—á–∫–∞:</span>
                    <span class="detail-value">{{ lunch_revenue|int }} ‚ÇΩ</span>
                </div>
                <div class="meal-detail-item">
                    <span class="detail-label">–°—Ä. —Ü–µ–Ω–∞:</span>
                    <span class="detail-value">{{ avg_lunch_price|int }} ‚ÇΩ</span>
                </div>
            </div>
        </div>

        <div class="meal-stat-card total-stat">
            <div class="meal-stat-visual">
                <div class="meal-stat-circle total-circle">
                    <svg viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="45" fill="none" stroke="#e9d5ff" stroke-width="10"/>
                        <circle cx="50" cy="50" r="45" fill="none" stroke="#7c3aed" stroke-width="10" 
                                stroke-dasharray="283 0"
                                stroke-linecap="round" transform="rotate(-90 50 50)"/>
                    </svg>
                    <div class="meal-stat-circle-content">
                        <span class="meal-stat-emoji">üìà</span>
                    </div>
                </div>
            </div>
            <div class="meal-stat-info">
                <div class="meal-stat-value">{{ total_meals }}</div>
                <div class="meal-stat-label">–í—Å–µ–≥–æ –ø–æ—Ä—Ü–∏–π</div>
                <div class="meal-stat-percent">100%</div>
            </div>
            <div class="meal-stat-details">
                <div class="meal-detail-item">
                    <span class="detail-label">–í—ã—Ä—É—á–∫–∞:</span>
                    <span class="detail-value">{{ total_revenue|int }} ‚ÇΩ</span>
                </div>
                <div class="meal-detail-item">
                    <span class="detail-label">–°—Ä. —á–µ–∫:</span>
                    <span class="detail-value">{{ avg_check|int }} ‚ÇΩ</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Orders History -->
<div class="reports-card reports-orders-card">
    <div class="reports-card-header">
        <div class="reports-card-title">
            <span>üßæ</span>
            <h3>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</h3>
        </div>
        <div class="orders-filter">
            <button class="filter-btn active" onclick="filterOrders('all')">–í—Å–µ</button>
            <button class="filter-btn" onclick="filterOrders('received')">–ü–æ–ª—É—á–µ–Ω–æ</button>
            <button class="filter-btn" onclick="filterOrders('pending')">–û–∂–∏–¥–∞–µ—Ç</button>
        </div>
    </div>
    <div class="reports-card-body">
        {% if recent_orders %}
        <div class="orders-table-wrapper">
            <table class="orders-table">
                <thead>
                    <tr>
                        <th>–ó–∞–∫–∞–∑</th>
                        <th>–£—á–µ–Ω–∏–∫</th>
                        <th>–¢–∏–ø</th>
                        <th>–°—É–º–º–∞</th>
                        <th>–î–∞—Ç–∞</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                    </tr>
                </thead>
                <tbody id="orders-table-body">
                    {% for order in recent_orders %}
                    <tr class="order-row" data-status="{{ order.status }}">
                        <td>
                            <span class="order-id">#{{ order.id }}</span>
                        </td>
                        <td>
                            <div class="order-user">
                                <div class="order-user-avatar">
                                    {{ order.user.name.split()[0][0] }}{{ order.user.name.split()[-1][0] if order.user.name.split()|length > 1 else '' }}
                                </div>
                                <div class="order-user-info">
                                    <span class="order-user-name">{{ order.user.name }}</span>
                                    <span class="order-user-class">{{ order.user.student_class or '–ù–µ —É–∫–∞–∑–∞–Ω' }}</span>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="order-type {% if order.meal_type == 'breakfast' %}type-breakfast{% else %}type-lunch{% endif %}">
                                {% if order.meal_type == 'breakfast' %}‚òÄÔ∏è –ó–∞–≤—Ç—Ä–∞–∫{% else %}üçΩÔ∏è –û–±–µ–¥{% endif %}
                            </span>
                        </td>
                        <td>
                            <span class="order-amount">{{ order.total|int }} ‚ÇΩ</span>
                        </td>
                        <td>
                            <div class="order-date">
                                <span class="date-day">{{ order.created_at.strftime('%d.%m') }}</span>
                                <span class="date-time">{{ order.created_at.strftime('%H:%M') }}</span>
                            </div>
                        </td>
                        <td>
                            <span class="order-status {% if order.status == 'received' %}status-received{% else %}status-pending{% endif %}">
                                {% if order.status == 'received' %}
                                <span class="status-icon">‚úì</span> –ü–æ–ª—É—á–µ–Ω–æ
                                {% else %}
                                <span class="status-icon">‚è≥</span> –û–∂–∏–¥–∞–µ—Ç
                                {% endif %}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="reports-empty">
            <span class="empty-icon">üì≠</span>
            <p>–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</p>
        </div>
        {% endif %}
    </div>
    {% if recent_orders %}
    <div class="reports-card-footer">
        <div class="orders-summary">
            <span>–ü–æ–∫–∞–∑–∞–Ω–æ {{ recent_orders|length }} –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–∞–∫–∞–∑–æ–≤ –∏–∑ {{ orders_count }}</span>
        </div>
    </div>
    {% endif %}
</div>

<!-- Export Options -->
<div class="reports-export-section">
    <div class="export-title">
        <span>üì•</span>
        <h3>–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h3>
    </div>
    <div class="export-options">
        <a href="{{ url_for('export_weekly_report') }}" class="export-option-btn">
            <span class="export-icon">üìÑ</span>
            <span class="export-format">–û–±—â–∏–π –æ—Ç—á–µ—Ç</span>
            <span class="export-desc">Word —Ñ–∞–π–ª –∑–∞ –Ω–µ–¥–µ–ª—é</span>
        </a>
        <a href="{{ url_for('export_daily_report') }}" class="export-option-btn">
            <span class="export-icon">üóìÔ∏è</span>
            <span class="export-format">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á–µ—Ç</span>
            <span class="export-desc">Word —Ñ–∞–π–ª –∑–∞ —Å–µ–≥–æ–¥–Ω—è</span>
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Filter buttons
function filterOrders(status) {
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    document.querySelectorAll('.order-row').forEach(row => {
        if (status === 'all') {
            row.style.display = '';
        } else if (row.dataset.status === status) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

</script>
{% endblock %}
