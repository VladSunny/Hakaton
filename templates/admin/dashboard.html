{% extends 'base.html' %}

{% block title %}Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°{% endblock %}

{% block content %}
<div class="page-top-spacing">
    <div class="page-header">
        <div class="stats-page-header">
            <h2 class="page-title">Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°</h2>
            <div class="stats-header-badges">
                <div class="stats-date-badge">
                    <span>ğŸ“…</span>
                    <span>{{ now.strftime('%d.%m.%Y') if now else 'Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ' }}</span>
                </div>
                <div class="stats-live-badge">
                    <span class="live-dot"></span>
                    <span>Live</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Stats Cards -->
<div class="stats-main-grid">
    <!-- Today Orders -->
    <div class="stats-card stats-card-purple">
        <div class="stats-card-bg-pattern"></div>
        <div class="stats-card-content">
            <div class="stats-card-icon">
                <span>ğŸ›’</span>
            </div>
            <div class="stats-card-info">
                <span class="stats-card-value">{{ today_orders }}</span>
                <span class="stats-card-label">Ğ—Ğ°ĞºĞ°Ğ·Ğ¾Ğ² ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ</span>
            </div>
        </div>
        <div class="stats-card-footer">
            {% if orders_change > 0 %}
            <span class="stats-trend stats-trend-up">â†‘ {{ orders_change }}%</span>
            {% elif orders_change < 0 %}
            <span class="stats-trend stats-trend-down">â†“ {{ orders_change|abs }}%</span>
            {% else %}
            <span class="stats-trend stats-trend-neutral">â†’ 0%</span>
            {% endif %}
            <span class="stats-trend-label">vs Ğ²Ñ‡ĞµÑ€Ğ°</span>
        </div>
    </div>

    <!-- Total Revenue -->
    <div class="stats-card stats-card-green">
        <div class="stats-card-bg-pattern"></div>
        <div class="stats-card-content">
            <div class="stats-card-icon">
                <span>ğŸ’°</span>
            </div>
            <div class="stats-card-info">
                <span class="stats-card-value">{{ total_revenue|int }} â‚½</span>
                <span class="stats-card-label">ĞĞ±Ñ‰Ğ°Ñ Ğ²Ñ‹Ñ€ÑƒÑ‡ĞºĞ°</span>
            </div>
        </div>
        <div class="stats-card-footer">
            <span class="stats-trend stats-trend-up">{{ total_orders }} Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ²</span>
            <span class="stats-trend-label">Ğ²ÑĞµĞ³Ğ¾</span>
        </div>
    </div>

    <!-- Students -->
    <div class="stats-card stats-card-blue">
        <div class="stats-card-bg-pattern"></div>
        <div class="stats-card-content">
            <div class="stats-card-icon">
                <span>ğŸ‘¥</span>
            </div>
            <div class="stats-card-info">
                <span class="stats-card-value">{{ students_count }}</span>
                <span class="stats-card-label">Ğ£Ñ‡ĞµĞ½Ğ¸ĞºĞ¾Ğ²</span>
            </div>
        </div>
        <div class="stats-card-footer">
            <span class="stats-trend stats-trend-ok">Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ…</span>
            <span class="stats-trend-label">Ğ² ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ</span>
        </div>
    </div>

    <!-- Pending Requests -->
    <div class="stats-card stats-card-orange">
        <div class="stats-card-bg-pattern"></div>
        <div class="stats-card-content">
            <div class="stats-card-icon">
                <span>ğŸ“‹</span>
            </div>
            <div class="stats-card-info">
                <span class="stats-card-value">{{ pending_requests }}</span>
                <span class="stats-card-label">Ğ—Ğ°ÑĞ²Ğ¾Ğº Ğ½Ğ° Ğ·Ğ°ĞºÑƒĞ¿ĞºÑƒ</span>
            </div>
        </div>
        <div class="stats-card-footer">
            {% if pending_requests > 0 %}
            <span class="stats-trend stats-trend-warning">âš ï¸ Ğ¢Ñ€ĞµĞ±ÑƒÑÑ‚ Ğ²Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ñ</span>
            {% else %}
            <span class="stats-trend stats-trend-ok">âœ“ Ğ’ÑÑ‘ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ¾</span>
            {% endif %}
        </div>
    </div>
</div>

<!-- Quick Metrics Row -->
<div class="quick-metrics-row">
    <div class="quick-metric">
        <span class="quick-metric-icon">â˜€ï¸</span>
        <div class="quick-metric-info">
            <span class="quick-metric-value">{{ breakfast_count }}</span>
            <span class="quick-metric-label">Ğ—Ğ°Ğ²Ñ‚Ñ€Ğ°ĞºĞ¾Ğ²</span>
        </div>
    </div>
    <div class="quick-metric">
        <span class="quick-metric-icon">ğŸ½ï¸</span>
        <div class="quick-metric-info">
            <span class="quick-metric-value">{{ lunch_count }}</span>
            <span class="quick-metric-label">ĞĞ±ĞµĞ´Ğ¾Ğ²</span>
        </div>
    </div>
    <div class="quick-metric">
        <span class="quick-metric-icon">â­</span>
        <div class="quick-metric-info">
            <span class="quick-metric-value">{{ avg_rating if avg_rating > 0 else 'â€”' }}</span>
            <span class="quick-metric-label">Ğ ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³</span>
        </div>
    </div>
    <div class="quick-metric">
        <span class="quick-metric-icon">ğŸ«</span>
        <div class="quick-metric-info">
            <span class="quick-metric-value">{{ subscriptions_count }}</span>
            <span class="quick-metric-label">ĞĞ±Ğ¾Ğ½ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²</span>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="stats-charts-grid">
    <!-- Weekly Chart -->
    <div class="stats-chart-card">
        <div class="stats-chart-header">
            <div class="stats-chart-title">
                <span class="stats-chart-icon">ğŸ“ˆ</span>
                <h3>Ğ”Ğ¸Ğ½Ğ°Ğ¼Ğ¸ĞºĞ° Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ² Ğ·Ğ° Ğ½ĞµĞ´ĞµĞ»Ñ</h3>
            </div>
        </div>
        <div class="stats-chart-body">
            <div class="chart-container">
                {% for day in weekly_orders %}
                <div class="chart-bar-wrapper">
                    <div class="chart-bar-value">{{ day.count }}</div>
                    <div class="chart-bar-track">
                        <div class="chart-bar-fill {% if day.count == max_weekly and day.count > 0 %}chart-bar-max{% endif %}" 
                             style="height: {{ (day.count / max_weekly * 100) if max_weekly > 0 else 0 }}%"></div>
                    </div>
                    <div class="chart-bar-label">{{ day.day }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="stats-chart-footer">
            <div class="chart-legend">
                <span class="legend-item">
                    <span class="legend-dot legend-dot-purple"></span>
                    Ğ’ÑĞµĞ³Ğ¾ Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ²: <strong>{{ total_orders }}</strong>
                </span>
                <span class="legend-item">
                    <span class="legend-dot legend-dot-green"></span>
                    Ğ’Ñ‹Ñ€ÑƒÑ‡ĞºĞ°: <strong>{{ total_revenue|int }} â‚½</strong>
                </span>
            </div>
        </div>
    </div>

    <!-- Meal Distribution -->
    <div class="stats-chart-card">
        <div class="stats-chart-header">
            <div class="stats-chart-title">
                <span class="stats-chart-icon">ğŸ¥§</span>
                <h3>Ğ Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¸Ñ‚Ğ°Ğ½Ğ¸Ñ</h3>
            </div>
        </div>
        <div class="stats-chart-body">
            <div class="pie-chart-container">
                <div class="pie-chart">
                    {% set total = breakfast_count + lunch_count %}
                    {% set breakfast_percent = (breakfast_count / total * 100) if total > 0 else 0 %}
                    {% set lunch_percent = (lunch_count / total * 100) if total > 0 else 0 %}
                    <div class="pie-chart-circle">
                        <svg viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="40" fill="none" stroke="#e5e7eb" stroke-width="20"/>
                            {% if total > 0 %}
                            <circle cx="50" cy="50" r="40" fill="none" stroke="#f59e0b" stroke-width="20" 
                                    stroke-dasharray="{{ breakfast_percent * 2.51 }} 251" stroke-dashoffset="0" transform="rotate(-90 50 50)"/>
                            <circle cx="50" cy="50" r="40" fill="none" stroke="#f97316" stroke-width="20" 
                                    stroke-dasharray="{{ lunch_percent * 2.51 }} 251" stroke-dashoffset="{{ -breakfast_percent * 2.51 }}" transform="rotate(-90 50 50)"/>
                            {% endif %}
                        </svg>
                        <div class="pie-chart-center">
                            <span class="pie-total">{{ total }}</span>
                            <span class="pie-label">Ğ¿Ğ¾Ñ€Ñ†Ğ¸Ğ¹</span>
                        </div>
                    </div>
                </div>
                <div class="pie-legend">
                    <div class="pie-legend-item">
                        <span class="pie-legend-color pie-legend-yellow"></span>
                        <div class="pie-legend-info">
                            <span class="pie-legend-label">Ğ—Ğ°Ğ²Ñ‚Ñ€Ğ°ĞºĞ¸</span>
                            <span class="pie-legend-value">{{ breakfast_count }} ({{ breakfast_percent|int }}%)</span>
                        </div>
                    </div>
                    <div class="pie-legend-item">
                        <span class="pie-legend-color pie-legend-orange"></span>
                        <div class="pie-legend-info">
                            <span class="pie-legend-label">ĞĞ±ĞµĞ´Ñ‹</span>
                            <span class="pie-legend-value">{{ lunch_count }} ({{ lunch_percent|int }}%)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity Section -->
<div class="stats-activity-section">
    <div class="stats-activity-grid">
        <!-- Recent Orders -->
        <div class="stats-activity-card">
            <div class="stats-activity-header">
                <div class="stats-activity-title">
                    <span>ğŸ§¾</span>
                    <h3>ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹</h3>
                </div>
                <a href="{{ url_for('admin_reports') }}" class="stats-view-all">
                    Ğ’ÑĞµ â†’
                </a>
            </div>
            <div class="stats-activity-body">
                {% if recent_orders %}
                <div class="recent-orders-list">
                    {% for order in recent_orders %}
                    <div class="recent-order-item">
                        <div class="recent-order-avatar">
                            {{ order.user.name.split()[0][0] }}{{ order.user.name.split()[-1][0] if order.user.name.split()|length > 1 else '' }}
                        </div>
                        <div class="recent-order-info">
                            <span class="recent-order-name">{{ order.user.name }}</span>
                            <span class="recent-order-meta">
                                {{ order.items|length }} Ğ¿Ğ¾Ğ·. â€¢ {{ order.created_at.strftime('%H:%M') }}
                            </span>
                        </div>
                        <div class="recent-order-right">
                            <span class="recent-order-amount">{{ order.total|int }} â‚½</span>
                            <span class="recent-order-status {% if order.status == 'received' %}status-done{% else %}status-pending{% endif %}">
                                {% if order.status == 'received' %}âœ“{% else %}â³{% endif %}
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="stats-empty">
                    <span class="stats-empty-icon">ğŸ“­</span>
                    <p>ĞĞµÑ‚ Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ²</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Top Dishes -->
        <div class="stats-activity-card">
            <div class="stats-activity-header">
                <div class="stats-activity-title">
                    <span>ğŸ†</span>
                    <h3>ĞŸĞ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ñ‹Ğµ Ğ±Ğ»ÑĞ´Ğ°</h3>
                </div>
            </div>
            <div class="stats-activity-body">
                {% if popular %}
                <div class="top-dishes-list">
                    {% for dish in popular %}
                    <div class="top-dish-item">
                        <span class="top-dish-rank {% if loop.index == 1 %}gold{% elif loop.index == 2 %}silver{% elif loop.index == 3 %}bronze{% endif %}">
                            {{ loop.index }}
                        </span>
                        <div class="top-dish-info">
                            <span class="top-dish-name">{{ dish[0] }}</span>
                            <div class="top-dish-bar">
                                <div class="top-dish-fill" style="width: {{ (dish[1] / max_popular * 100)|int }}%"></div>
                            </div>
                        </div>
                        <span class="top-dish-count">{{ dish[1] }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="stats-empty">
                    <span class="stats-empty-icon">ğŸ“­</span>
                    <p>ĞĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¾ Ğ¿Ğ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ñ‹Ñ… Ğ±Ğ»ÑĞ´Ğ°Ñ…</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="stats-quick-actions">
    <a href="{{ url_for('admin_reports') }}" class="stats-action-btn">
        <span class="stats-action-icon">ğŸ“Š</span>
        <span>ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚</span>
    </a>
    <a href="{{ url_for('admin_requests') }}" class="stats-action-btn">
        <span class="stats-action-icon">ğŸ“‹</span>
        <span>Ğ—Ğ°ÑĞ²ĞºĞ¸ ({{ pending_requests }})</span>
    </a>
    <a href="{{ url_for('admin_users') }}" class="stats-action-btn">
        <span class="stats-action-icon">ğŸ‘¥</span>
        <span>ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸</span>
    </a>
    <button onclick="exportDashboard()" class="stats-action-btn stats-action-primary">
        <span class="stats-action-icon">ğŸ“¥</span>
        <span>Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚</span>
    </button>
</div>
{% endblock %}

{% block scripts %}
<script>
function exportDashboard() {
    const data = {
        date: new Date().toLocaleDateString('ru-RU'),
        today_orders: {{ today_orders }},
        total_orders: {{ total_orders }},
        total_revenue: {{ total_revenue|int }},
        students_count: {{ students_count }},
        pending_requests: {{ pending_requests }},
        breakfast_count: {{ breakfast_count }},
        lunch_count: {{ lunch_count }},
        subscriptions_count: {{ subscriptions_count }},
        avg_rating: {{ avg_rating }}
    };
    
    const report = `
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘     Ğ¡Ğ¢ĞĞ¢Ğ˜Ğ¡Ğ¢Ğ˜ĞšĞ Ğ¨ĞšĞĞ›Ğ¬ĞĞĞ“Ğ ĞŸĞ˜Ğ¢ĞĞĞ˜Ğ¯         â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Ğ”Ğ°Ñ‚Ğ°: ${data.date}
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  ğŸ“Š ĞĞ¡ĞĞĞ’ĞĞ«Ğ• ĞŸĞĞšĞĞ—ĞĞ¢Ğ•Ğ›Ğ˜
â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â•‘  ğŸ›’ Ğ—Ğ°ĞºĞ°Ğ·Ğ¾Ğ² ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ:     ${data.today_orders}
â•‘  ğŸ›’ Ğ—Ğ°ĞºĞ°Ğ·Ğ¾Ğ² Ğ²ÑĞµĞ³Ğ¾:       ${data.total_orders}
â•‘  ğŸ’° ĞĞ±Ñ‰Ğ°Ñ Ğ²Ñ‹Ñ€ÑƒÑ‡ĞºĞ°:       ${data.total_revenue} â‚½
â•‘  ğŸ‘¥ Ğ£Ñ‡ĞµĞ½Ğ¸ĞºĞ¾Ğ²:            ${data.students_count}
â•‘  ğŸ“‹ Ğ—Ğ°ÑĞ²Ğ¾Ğº Ğ½Ğ° Ğ·Ğ°ĞºÑƒĞ¿ĞºÑƒ:   ${data.pending_requests}
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  ğŸ½ï¸ ĞŸĞ˜Ğ¢ĞĞĞ˜Ğ•
â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â•‘  â˜€ï¸ Ğ—Ğ°Ğ²Ñ‚Ñ€Ğ°ĞºĞ¾Ğ²:           ${data.breakfast_count}
â•‘  ğŸ½ï¸ ĞĞ±ĞµĞ´Ğ¾Ğ²:              ${data.lunch_count}
â•‘  ğŸ« ĞĞ±Ğ¾Ğ½ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²:         ${data.subscriptions_count}
â•‘  â­ Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹ Ñ€ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³:     ${data.avg_rating}
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    `;
    
    const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `statistics_${new Date().toISOString().split('T')[0]}.txt`;
    a.click();
    URL.revokeObjectURL(url);
    showToast('Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° ÑĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ°', 'success');
}
</script>
{% endblock %}
