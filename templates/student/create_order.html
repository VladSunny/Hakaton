{% extends "base.html" %}

{% block title %}–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="flex flex-col lg:flex-row gap-6">
        <!-- Left Panel: Day Selection -->
        <div class="lg:w-1/4">
            <div class="card sticky top-6">
                <div class="card-header">
                    <h2 class="text-xl font-bold text-gray-800">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å</h2>
                </div>
                <div class="card-body">
                    <div class="space-y-2">
                        <button class="day-btn w-full text-left px-4 py-3 rounded-lg hover:bg-purple-100 transition-colors flex items-center" data-day="monday">
                            <span class="mr-3">üìÖ</span> –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
                        </button>
                        <button class="day-btn w-full text-left px-4 py-3 rounded-lg hover:bg-purple-100 transition-colors flex items-center" data-day="tuesday">
                            <span class="mr-3">üìÖ</span> –í—Ç–æ—Ä–Ω–∏–∫
                        </button>
                        <button class="day-btn w-full text-left px-4 py-3 rounded-lg hover:bg-purple-100 transition-colors flex items-center" data-day="wednesday">
                            <span class="mr-3">üìÖ</span> –°—Ä–µ–¥–∞
                        </button>
                        <button class="day-btn w-full text-left px-4 py-3 rounded-lg hover:bg-purple-100 transition-colors flex items-center" data-day="thursday">
                            <span class="mr-3">üìÖ</span> –ß–µ—Ç–≤–µ—Ä–≥
                        </button>
                        <button class="day-btn w-full text-left px-4 py-3 rounded-lg hover:bg-purple-100 transition-colors flex items-center" data-day="friday">
                            <span class="mr-3">üìÖ</span> –ü—è—Ç–Ω–∏—Ü–∞
                        </button>
                        <button class="day-btn w-full text-left px-4 py-3 rounded-lg hover:bg-purple-100 transition-colors flex items-center" data-day="saturday">
                            <span class="mr-3">üìÖ</span> –°—É–±–±–æ—Ç–∞
                        </button>
                    </div>

                    <div class="mt-8">
                        <button id="submit-order" class="btn btn-primary btn-block">
                            üìù –°–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel: Products Tiles -->
        <div class="lg:w-3/4">
            <div class="card">
                <div class="card-header">
                    <h2 class="text-xl font-bold text-gray-800">–ú–µ–Ω—é –Ω–∞ <span id="selected-day-text">–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</span></h2>
                </div>
                <div class="card-body">
                    <div id="products-tiles-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Product tiles will be loaded here dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Pass Flask template variables to JavaScript
window.BREAKFAST_DATA = {{ breakfast | tojson }};
window.LUNCH_DATA = {{ lunch | tojson }};

document.addEventListener('DOMContentLoaded', function() {
    // Days mapping
    const daysMap = {
        'monday': '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫',
        'tuesday': '–í—Ç–æ—Ä–Ω–∏–∫',
        'wednesday': '–°—Ä–µ–¥–∞',
        'thursday': '–ß–µ—Ç–≤–µ—Ä–≥',
        'friday': '–ü—è—Ç–Ω–∏—Ü–∞',
        'saturday': '–°—É–±–±–æ—Ç–∞'
    };

    // Store quantities for each day
    const dayQuantities = {};

    // Current selected day
    let currentDay = 'monday';
    
    // Day buttons
    const dayButtons = document.querySelectorAll('.day-btn');
    dayButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Save current day's quantities before switching
            saveCurrentDayQuantities();

            // Remove active class from all buttons
            dayButtons.forEach(btn => btn.classList.remove('bg-purple-100'));

            // Add active class to clicked button
            this.classList.add('bg-purple-100');

            // Update current day
            currentDay = this.getAttribute('data-day');

            // Update selected day text
            document.getElementById('selected-day-text').textContent = daysMap[currentDay];

            // Reload products for the selected day
            loadProductsForDay(currentDay);
        });
    });

    // Initially select Monday
    document.querySelector('[data-day="monday"]').classList.add('bg-purple-100');
    
    // Load initial products
    loadProductsForDay(currentDay);

    // Function to load products for a specific day
    function loadProductsForDay(day) {
        // In a real implementation, you would fetch products for the specific day
        // For now, we'll just reload the same products but in a real app you might have different products per day
        loadAllProducts();
    }

    // Function to save current day's quantities
    function saveCurrentDayQuantities() {
        const quantityInputs = document.querySelectorAll(`.quantity-input[data-day="${currentDay}"]`);
        dayQuantities[currentDay] = {};

        quantityInputs.forEach(input => {
            const productId = input.getAttribute('data-product-id');
            const quantity = parseInt(input.value);
            dayQuantities[currentDay][productId] = quantity;
        });
    }

    // Function to get quantity for a product on a specific day
    function getQuantityForDay(productId, day) {
        if (dayQuantities[day] && dayQuantities[day][productId] !== undefined) {
            return dayQuantities[day][productId];
        }
        return 0; // Default to 0 if no value is stored
    }

    // Function to load all products as tiles
    function loadAllProducts() {
        // Clear existing products
        const container = document.getElementById('products-tiles-container');
        container.innerHTML = '';

        // Get products from Flask template variables (defined in script tag)
        const breakfast = window.BREAKFAST_DATA || [];
        const lunch = window.LUNCH_DATA || [];

        // Combine breakfast and lunch products
        const allProducts = [];

        // Add breakfast items
        breakfast.forEach(item => {
            allProducts.push({
                id: item.id,
                name: item.name,
                type: '–ó–∞–≤—Ç—Ä–∞–∫',
                price: item.price
            });
        });

        // Add lunch items
        lunch.forEach(item => {
            allProducts.push({
                id: item.id,
                name: item.name,
                type: '–û–±–µ–¥',
                price: item.price
            });
        });

        // Add products as tiles
        allProducts.forEach(product => {
            // Get the saved quantity for this product on the current day
            const savedQuantity = getQuantityForDay(product.id, currentDay);

            const tile = document.createElement('div');
            tile.className = 'menu-card';
            tile.innerHTML = `
                <div class="menu-card-body">
                    <div class="menu-card-header">
                        <div class="menu-card-emoji">üçΩÔ∏è</div>
                        <div class="menu-card-price">${product.price} ‚ÇΩ</div>
                    </div>
                    <div class="menu-card-content">
                        <h3 class="menu-card-title">${product.name}</h3>
                        <div class="menu-card-meta">
                            <span class="badge badge-primary">${product.type}</span>
                        </div>
                    </div>
                    <div class="menu-card-actions">
                        <div class="flex items-center justify-between w-full">
                            <span class="text-gray-700">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</span>
                            <div class="flex items-center border rounded">
                                <button class="quantity-decrease w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100" data-product-id="${product.id}" data-day="${currentDay}">-</button>
                                <input type="number" class="quantity-input w-12 h-8 text-center border-x" value="${savedQuantity}" min="0" max="2" data-product-id="${product.id}" data-day="${currentDay}" readonly>
                                <button class="quantity-increase w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-gray-100" data-product-id="${product.id}" data-day="${currentDay}">+</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(tile);
        });

        // Add event listeners to the new buttons
        addQuantityButtonListeners();
    }

    // Function to add event listeners to quantity buttons
    function addQuantityButtonListeners() {
        // Add event listeners to decrease buttons
        document.querySelectorAll('.quantity-decrease').forEach(button => {
            button.removeEventListener('click', handleDecreaseClick); // Remove old listeners to prevent duplicates
            button.addEventListener('click', handleDecreaseClick);
        });

        // Add event listeners to increase buttons
        document.querySelectorAll('.quantity-increase').forEach(button => {
            button.removeEventListener('click', handleIncreaseClick); // Remove old listeners to prevent duplicates
            button.addEventListener('click', handleIncreaseClick);
        });
    }

    // Handler for decrease button
    function handleDecreaseClick(event) {
        const button = event.target;
        const input = button.parentElement.querySelector('.quantity-input');
        let value = parseInt(input.value);
        if (value > 0) {
            value--;
            input.value = value;

            // Save the updated quantity for the current day
            const productId = input.getAttribute('data-product-id');
            if (!dayQuantities[currentDay]) {
                dayQuantities[currentDay] = {};
            }
            dayQuantities[currentDay][productId] = value;
        }
    }

    // Handler for increase button
    function handleIncreaseClick(event) {
        const button = event.target;
        const input = button.parentElement.querySelector('.quantity-input');
        let value = parseInt(input.value);
        if (value < 2) {
            value++;
            input.value = value;

            // Save the updated quantity for the current day
            const productId = input.getAttribute('data-product-id');
            if (!dayQuantities[currentDay]) {
                dayQuantities[currentDay] = {};
            }
            dayQuantities[currentDay][productId] = value;
        }
    }

    // Submit order button
    document.getElementById('submit-order').addEventListener('click', function() {
        // Collect order data
        const orderData = {};

        // Initialize days
        const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        days.forEach(day => {
            orderData[day] = {};
        });

        // Get all quantity inputs
        const quantityInputs = document.querySelectorAll('.quantity-input');
        quantityInputs.forEach(input => {
            const productId = input.getAttribute('data-product-id');
            const day = input.getAttribute('data-day');
            const quantity = parseInt(input.value);

            // Skip if quantity is 0
            if (quantity > 0) {
                // Initialize user object if it doesn't exist
                if (!orderData[day]['user{{ current_user.id }}']) {
                    orderData[day]['user{{ current_user.id }}'] = {};
                }

                // Add product ID and quantity to the user's order for this day
                orderData[day]['user{{ current_user.id }}'][productId] = quantity;
            }
        });

        // Send order data to the backend
        fetch('/api/create_order', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
            },
            body: JSON.stringify(orderData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
            } else {
                showToast(data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–∫–∞–∑–∞', 'error');
        });
    });
    
    // Helper function to get product name by ID
    function getProductById(id) {
        const breakfast = window.BREAKFAST_DATA || [];
        const lunch = window.LUNCH_DATA || [];

        // Search in breakfast items
        for (const item of breakfast) {
            if (item.id == id) {
                return item.name;
            }
        }

        // Search in lunch items
        for (const item of lunch) {
            if (item.id == id) {
                return item.name;
            }
        }

        return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç';
    }

    // Initialize the first day's products when the page loads
    loadAllProducts();
    
    // Show toast notification
    function showToast(message, type) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = `toast ${type}`;
        toast.classList.remove('hidden');

        setTimeout(() => {
            toast.classList.add('hidden');
        }, 3000);
    }
});
</script>

<!-- Toast element -->
<div id="toast" class="toast hidden"></div>
{% endblock %}