{% extends "base.html" %}

{% block title %}–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="flex flex-col lg:flex-row gap-6">
        <!-- Left Panel: Day Selection -->
        <div class="lg:w-1/4">
            <div class="bg-white rounded-lg shadow-md p-6 sticky top-6">
                <h2 class="text-xl font-bold mb-4 text-gray-800">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å</h2>
                <div class="space-y-2">
                    <button class="day-btn w-full text-left px-4 py-3 rounded-lg hover:bg-purple-100 transition-colors flex items-center" data-day="monday">
                        <span class="mr-3">üìÖ</span> –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
                    </button>
                    <button class="day-btn w-full text-left px-4 py-3 rounded-lg hover:bg-purple-100 transition-colors flex items-center" data-day="tuesday">
                        <span class="mr-3">üìÖ</span> –í—Ç–æ—Ä–Ω–∏–∫
                    </button>
                    <button class="day-btn w-full text-left px-4 py-3 rounded-lg hover:bg-purple-100 transition-colors flex items-center" data-day="wednesday">
                        <span class="mr-3">üìÖ</span> –°—Ä–µ–¥–∞
                    </button>
                    <button class="day-btn w-full text-left px-4 py-3 rounded-lg hover:bg-purple-100 transition-colors flex items-center" data-day="thursday">
                        <span class="mr-3">üìÖ</span> –ß–µ—Ç–≤–µ—Ä–≥
                    </button>
                    <button class="day-btn w-full text-left px-4 py-3 rounded-lg hover:bg-purple-100 transition-colors flex items-center" data-day="friday">
                        <span class="mr-3">üìÖ</span> –ü—è—Ç–Ω–∏—Ü–∞
                    </button>
                    <button class="day-btn w-full text-left px-4 py-3 rounded-lg hover:bg-purple-100 transition-colors flex items-center" data-day="saturday">
                        <span class="mr-3">üìÖ</span> –°—É–±–±–æ—Ç–∞
                    </button>
                </div>
                
                <div class="mt-8">
                    <button id="submit-order" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                        üìù –°–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑
                    </button>
                </div>
            </div>
        </div>

        <!-- Right Panel: Products Table -->
        <div class="lg:w-3/4">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-4 text-gray-800">–ú–µ–Ω—é –Ω–∞ <span id="selected-day-text">–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</span></h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ë–ª—é–¥–æ</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–¢–∏–ø</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–¶–µ–Ω–∞</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                            </tr>
                        </thead>
                        <tbody id="products-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Products will be loaded here dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Pass Flask template variables to JavaScript
window.BREAKFAST_DATA = {{ breakfast | tojson }};
window.LUNCH_DATA = {{ lunch | tojson }};

document.addEventListener('DOMContentLoaded', function() {
    // Days mapping
    const daysMap = {
        'monday': '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫',
        'tuesday': '–í—Ç–æ—Ä–Ω–∏–∫',
        'wednesday': '–°—Ä–µ–¥–∞',
        'thursday': '–ß–µ—Ç–≤–µ—Ä–≥',
        'friday': '–ü—è—Ç–Ω–∏—Ü–∞',
        'saturday': '–°—É–±–±–æ—Ç–∞'
    };

    // Current selected day
    let currentDay = 'monday';
    
    // Day buttons
    const dayButtons = document.querySelectorAll('.day-btn');
    dayButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            dayButtons.forEach(btn => btn.classList.remove('bg-purple-100'));
            
            // Add active class to clicked button
            this.classList.add('bg-purple-100');
            
            // Update current day
            currentDay = this.getAttribute('data-day');
            
            // Update selected day text
            document.getElementById('selected-day-text').textContent = daysMap[currentDay];
            
            // Reload products for the selected day
            loadProductsForDay(currentDay);
        });
    });

    // Initially select Monday
    document.querySelector('[data-day="monday"]').classList.add('bg-purple-100');
    
    // Load initial products
    loadProductsForDay(currentDay);

    // Function to load products for a specific day
    function loadProductsForDay(day) {
        // In a real implementation, you would fetch products for the specific day
        // For now, we'll just reload the same products but in a real app you might have different products per day
        loadAllProducts();
    }

    // Function to load all products
    function loadAllProducts() {
        // Clear existing products
        const tableBody = document.getElementById('products-table-body');
        tableBody.innerHTML = '';

        // Get products from Flask template variables (defined in script tag)
        const breakfast = window.BREAKFAST_DATA || [];
        const lunch = window.LUNCH_DATA || [];

        // Combine breakfast and lunch products
        const allProducts = [];

        // Add breakfast items
        breakfast.forEach(item => {
            allProducts.push({
                id: item.id,
                name: item.name,
                type: '–ó–∞–≤—Ç—Ä–∞–∫',
                price: item.price
            });
        });

        // Add lunch items
        lunch.forEach(item => {
            allProducts.push({
                id: item.id,
                name: item.name,
                type: '–û–±–µ–¥',
                price: item.price
            });
        });

        // Add products to the table
        allProducts.forEach(product => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${product.name}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.type}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.price} ‚ÇΩ</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <div class="flex items-center">
                        <select class="quantity-select border rounded px-2 py-1 w-16" data-product-id="${product.id}" data-day="${currentDay}">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                        </select>
                    </div>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

    // Submit order button
    document.getElementById('submit-order').addEventListener('click', function() {
        // Collect order data
        const orderData = {};

        // Initialize days
        const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        days.forEach(day => {
            orderData[day] = {};
        });

        // Get all quantity selects
        const quantitySelects = document.querySelectorAll('.quantity-select');
        quantitySelects.forEach(select => {
            const productId = select.getAttribute('data-product-id');
            const day = select.getAttribute('data-day');
            const quantity = parseInt(select.value);

            // Skip if quantity is 0
            if (quantity > 0) {
                const productName = getProductById(productId);

                // Initialize user object if it doesn't exist
                if (!orderData[day]['{{ current_user.email }}']) {
                    orderData[day]['{{ current_user.email }}'] = {};
                }

                // Add product and quantity to the user's order for this day
                orderData[day]['{{ current_user.email }}'][productName] = quantity;
            }
        });

        // Send order data to the backend
        fetch('/api/create_order', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
            },
            body: JSON.stringify(orderData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
            } else {
                showToast(data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–∫–∞–∑–∞', 'error');
        });
    });
    
    // Helper function to get product name by ID
    function getProductById(id) {
        const breakfast = window.BREAKFAST_DATA || [];
        const lunch = window.LUNCH_DATA || [];

        // Search in breakfast items
        for (const item of breakfast) {
            if (item.id == id) {
                return item.name;
            }
        }

        // Search in lunch items
        for (const item of lunch) {
            if (item.id == id) {
                return item.name;
            }
        }

        return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç';
    }
    
    // Show toast notification
    function showToast(message, type) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = `toast ${type}`;
        toast.classList.remove('hidden');

        setTimeout(() => {
            toast.classList.add('hidden');
        }, 3000);
    }
});
</script>

<!-- Toast element -->
<div id="toast" class="toast hidden"></div>
{% endblock %}