{% extends 'base.html' %}

{% block title %}–û–ø–ª–∞—Ç–∞{% endblock %}

{% block content %}
<div class="page-top-spacing">
    <div class="page-header">
        <h2 class="page-title">–û–ø–ª–∞—Ç–∞ (–Ω–µ–¥–µ–ª—è 1)</h2>
    </div>
</div>

<!-- Weekly Menu Table -->
<div class="card menu-table-card" style="margin-bottom: 20px;">
    <div class="card-body">
        <h3 class="payment-section-title">
            <span class="payment-section-icon">üçΩÔ∏è</span>
            –ú–µ–Ω—é –Ω–∞ –Ω–µ–¥–µ–ª—é
        </h3>
        <table class="menu-table">
            <thead>
                <tr>
                    <th>–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏</th>
                    <th>–ë–ª—é–¥–æ</th>
                    <th>–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</td>
                    <td>–ë–æ—Ä—â, –∫–æ—Ç–ª–µ—Ç–∞ —Å –ø—é—Ä–µ, –∫–æ–º–ø–æ—Ç</td>
                    <td>180 ‚ÇΩ</td>
                </tr>
                <tr>
                    <td>–í—Ç–æ—Ä–Ω–∏–∫</td>
                    <td>–°—É–ø –º–∏–Ωestrone, –∑–∞–ø–µ–∫–∞–Ω–∫–∞ —Å –∏–∑—é–º–æ–º, —á–∞–π</td>
                    <td>165 ‚ÇΩ</td>
                </tr>
                <tr>
                    <td>–°—Ä–µ–¥–∞</td>
                    <td>–ì—Ä–∏–±–Ω–æ–π –∫—Ä–µ–º-—Å—É–ø, –∫—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞ —Å —Ä–∏—Å–æ–º, –º–æ—Ä—Å</td>
                    <td>190 ‚ÇΩ</td>
                </tr>
                <tr>
                    <td>–ß–µ—Ç–≤–µ—Ä–≥</td>
                    <td>–©–∏, —Ä—ã–±–Ω–∞—è –∫–æ—Ç–ª–µ—Ç–∞ —Å –≥—Ä–µ—á–∫–æ–π, —Å–æ–∫</td>
                    <td>175 ‚ÇΩ</td>
                </tr>
                <tr>
                    <td>–ü—è—Ç–Ω–∏—Ü–∞</td>
                    <td>–¢–æ–º–∞—Ç–Ω—ã–π —Å—É–ø, –º–∞–∫–∞—Ä–æ–Ω—ã —Å —Å—ã—Ä–æ–º, –∫–æ–º–ø–æ—Ç</td>
                    <td>155 ‚ÇΩ</td>
                </tr>
                <tr>
                    <td>–°—É–±–±–æ—Ç–∞</td>
                    <td>–°–æ–ª—è–Ω–∫–∞, —Å–≤–∏–Ω–∏–Ω–∞ —Å –∫–∞—Ä—Ç–æ—à–∫–æ–π, —á–∞–π</td>
                    <td>200 ‚ÇΩ</td>
                </tr>
                <tr>
                    <th>–ò—Ç–æ–≥–æ:</th>
                    <th></th>
                    <th>1065 ‚ÇΩ</th>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<div class="payment-form-container">
    <!-- Balance Card -->
    <div class="card">
        <div class="card-body">
            <!-- Balance Display -->
            <div class="balance-card-display">
                <div class="balance-icon-wrapper">
                    <span class="balance-icon">üí∞</span>
                </div>
                <div class="balance-info">
                    <p class="balance-label">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</p>
                    <p id="balance-display" class="balance-amount">1065 ‚ÇΩ</p>
                </div>
            </div>

            <!-- Divider -->
            <div class="payment-divider"></div>

            <!-- Fake Card Details Form -->
            <div class="card-details-form">
                <h3 class="payment-section-title">
                    <span class="payment-section-icon">üí≥</span>
                    –í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã
                </h3>

                <form id="card-details-form" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="card-number" class="form-label">–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã</label>
                        <input type="text" id="card-number" class="form-control" placeholder="1234 5678 9012 3456" maxlength="19">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="expiry-date" class="form-label">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è</label>
                            <input type="text" id="expiry-date" class="form-control" placeholder="MM/YY" maxlength="5">
                        </div>
                        <div class="form-group">
                            <label for="cvv" class="form-label">CVV</label>
                            <input type="password" id="cvv" class="form-control" placeholder="123" maxlength="3">
                        </div>
                    </div>

                    <!-- File Upload for Payment Confirmation –æ–∞—ã–ª–≤—ã—à–ª-->
                    <div class="form-group">
                        <label for="payment-proof" class="form-label">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã</label>
                        <input type="file" id="payment-proof" class="form-control" accept=".png,.jpeg,.jpg,.pdf" />
                        <small class="form-hint">–î–æ–ø—É—Å—Ç–∏–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: PNG, JPEG, JPG, PDF</small>
                    </div>

                    <button type="submit" class="btn btn-primary topup-custom-btn">
                        –û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Format card number as user types
document.getElementById('card-number').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length > 16) value = value.substring(0, 16);

    // Format as XXXX XXXX XXXX XXXX
    let formattedValue = '';
    for (let i = 0; i < value.length; i++) {
        if (i > 0 && i % 4 === 0) formattedValue += ' ';
        formattedValue += value[i];
    }

    e.target.value = formattedValue;
});

// Format expiry date as user types
document.getElementById('expiry-date').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length > 4) value = value.substring(0, 4);

    // Format as MM/YY
    if (value.length >= 2) {
        value = value.substring(0, 2) + '/' + value.substring(2);
    }

    e.target.value = value;
});

// Handle form submission
document.getElementById('card-details-form').addEventListener('submit', function(e) {
    e.preventDefault();

    const cardNumber = document.getElementById('card-number').value;
    const expiryDate = document.getElementById('expiry-date').value;
    const cvv = document.getElementById('cvv').value;
    const cardHolder = document.getElementById('card-holder').value;
    const amount = document.getElementById('amount').value;
    const paymentProof = document.getElementById('payment-proof').files[0];

    // Validate inputs
    if (!cardNumber || !expiryDate || !cvv || !cardHolder || !amount) {
        showToast('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
        return;
    }

    if (amount <= 0) {
        showToast('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É', 'error');
        return;
    }

    if (!paymentProof) {
        showToast('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã', 'error');
        return;
    }

    // Check file type
    const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'application/pdf'];
    if (!validTypes.includes(paymentProof.type)) {
        showToast('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞. –†–∞–∑—Ä–µ—à–µ–Ω—ã: PNG, JPEG, JPG, PDF', 'error');
        return;
    }

    // Create FormData object to send both form data and file
    const formData = new FormData();
    formData.append('card_number', cardNumber.replace(/\s/g, '')); // Remove spaces
    formData.append('expiry_date', expiryDate);
    formData.append('cvv', cvv);
    formData.append('card_holder', cardHolder);
    formData.append('amount', amount);
    formData.append('payment_proof', paymentProof);

    // Send the data to the server
    fetch('/api/payment', {
        method: 'POST',
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            document.getElementById('balance-display').textContent = data.new_balance + ' ‚ÇΩ';

            // Reset form
            document.getElementById('card-details-form').reset();
        } else {
            showToast(data.message, 'error');
        }
    })
    .catch(error => {
        showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö', 'error');
    });
});

function topUp(amount) {
    if (!amount || amount <= 0) {
        showToast('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É', 'error');
        return;
    }

    fetch('/api/topup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ amount: amount })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            document.getElementById('balance-display').textContent = data.new_balance + ' ‚ÇΩ';
            document.getElementById('custom-amount').value = '';
        } else {
            showToast(data.message, 'error');
        }
    });
}

function buySubscription(type) {
    fetch('/api/subscription', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ type: type })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            location.reload();
        } else {
            showToast(data.message, 'error');
        }
    });
}
</script>
{% endblock %}
