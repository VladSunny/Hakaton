{% extends 'base.html' %}

{% block title %}–ü—Ä–æ—Ñ–∏–ª—å{% endblock %}

{% block content %}
<div class="page-top-spacing">
    <div class="page-header mb-8">
        <h2 class="page-title">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
    </div>
</div>

<div class="profile-page-grid">
    <!-- Profile Card -->
    <div class="profile-main-card">
        <!-- Header with gradient -->
        <div class="profile-card-header">
            <div class="profile-header-pattern"></div>
        </div>
        
        <!-- Avatar -->
        <div class="profile-avatar-wrapper">
            <div class="profile-avatar-large">
                {{ current_user.name.split()[0][0] }}{{ current_user.name.split()[-1][0] if current_user.name.split()|length > 1 else '' }}
            </div>
            <div class="profile-online-badge">‚úì</div>
        </div>
        
        <!-- User Info -->
        <div class="profile-info-section">
            <h3 class="profile-name">{{ current_user.name }}</h3>
            <div class="profile-class-badge">
                <span class="profile-class-icon">üéì</span>
                <span>{{ current_user.student_class }}</span>
            </div>
            <p class="profile-email">{{ current_user.email }}</p>
            <button onclick="openEditProfileModal()" class="btn btn-secondary mt-4">
                <span>‚úèÔ∏è</span> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
            </button>
        </div>
        
        <!-- Stats Grid -->
        <div class="profile-stats-grid">
            <div class="profile-stat-card profile-stat-balance">
                <div class="profile-stat-icon-wrapper">
                    <span>üí∞</span>
                </div>
                <div class="profile-stat-content">
                    <span class="profile-stat-number">{{ current_user.balance }}</span>
                    <span class="profile-stat-currency">‚ÇΩ</span>
                </div>
                <span class="profile-stat-name">–ë–∞–ª–∞–Ω—Å</span>
            </div>
            <div class="profile-stat-card profile-stat-orders">
                <div class="profile-stat-icon-wrapper">
                    <span>üõí</span>
                </div>
                <div class="profile-stat-content">
                    <span class="profile-stat-number">{{ orders_count }}</span>
                </div>
                <span class="profile-stat-name">–ó–∞–∫–∞–∑–æ–≤</span>
            </div>
            <div class="profile-stat-card profile-stat-rating">
                <div class="profile-stat-icon-wrapper">
                    <span>‚≠ê</span>
                </div>
                <div class="profile-stat-content">
                    <span class="profile-stat-number">4.8</span>
                </div>
                <span class="profile-stat-name">–†–µ–π—Ç–∏–Ω–≥</span>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="profile-quick-actions">
            <a href="{{ url_for('student_payment') }}" class="profile-action-btn profile-action-primary">
                <span class="profile-action-icon">üí≥</span>
                <span>–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</span>
            </a>
            <a href="{{ url_for('student_orders') }}" class="profile-action-btn profile-action-secondary">
                <span class="profile-action-icon">üìã</span>
                <span>–ú–æ–∏ –∑–∞–∫–∞–∑—ã</span>
            </a>
        </div>
    </div>
    
    <!-- Right Column -->
    <div class="profile-right-column">
        <!-- Allergies Card -->
        <div class="profile-settings-card">
            <div class="profile-settings-header">
                <div class="profile-settings-icon allergy-icon">
                    <span>‚ö†Ô∏è</span>
                </div>
                <div class="profile-settings-title">
                    <h3>–ü–∏—â–µ–≤—ã–µ –∞–ª–ª–µ—Ä–≥–∏–∏</h3>
                    <p>–ë–ª—é–¥–∞ —Å –∞–ª–ª–µ—Ä–≥–µ–Ω–∞–º–∏ –±—É–¥—É—Ç –≤—ã–¥–µ–ª–µ–Ω—ã</p>
                </div>
            </div>
            
            <div class="allergens-selection" id="allergies-container">
                {% for allergen in all_allergens %}
                <button onclick="toggleAllergen('{{ allergen }}')" 
                        class="allergen-chip {% if allergen in user_allergies %}active{% endif %}"
                        data-allergen="{{ allergen }}">
                    <span class="allergen-icon">
                        {% if allergen == '–≥–ª—é—Ç–µ–Ω' %}üåæ{% elif allergen == '–º–æ–ª–æ–∫–æ' %}ü•õ{% elif allergen == '—è–π—Ü–∞' %}ü•ö{% elif allergen == '–æ—Ä–µ—Ö–∏' %}ü•ú{% elif allergen == '—Ä—ã–±–∞' %}üêü{% elif allergen == '—Å–æ—è' %}ü´ò{% elif allergen == '–∞—Ä–∞—Ö–∏—Å' %}ü•ú{% else %}‚ùå{% endif %}
                    </span>
                    <span class="allergen-name">{{ allergen }}</span>
                    <span class="allergen-check">‚úì</span>
                </button>
                {% endfor %}
            </div>
            
            <div class="allergen-hint">
                <span class="hint-icon">üí°</span>
                <span>–í—ã–±—Ä–∞–Ω–Ω—ã–µ –∞–ª–ª–µ—Ä–≥–µ–Ω—ã: <strong>{{ user_allergies|length }}</strong></span>
            </div>
        </div>
        
        <!-- Preferences Card -->
        <div class="profile-settings-card">
            <div class="profile-settings-header">
                <div class="profile-settings-icon preferences-icon">
                    <span>‚öôÔ∏è</span>
                </div>
                <div class="profile-settings-title">
                    <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                    <p>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è</p>
                </div>
            </div>
            
            <div class="settings-list">
                <div class="setting-item">
                    <div class="setting-info">
                        <span class="setting-icon">üîî</span>
                        <div class="setting-text">
                            <span class="setting-name">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
                            <span class="setting-desc">–û –Ω–æ–≤—ã—Ö –±–ª—é–¥–∞—Ö –∏ –∞–∫—Ü–∏—è—Ö</span>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <span class="setting-icon">üìß</span>
                        <div class="setting-text">
                            <span class="setting-name">Email-—Ä–∞—Å—Å—ã–ª–∫–∞</span>
                            <span class="setting-desc">–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–µ –º–µ–Ω—é</span>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <span class="setting-icon">üåô</span>
                        <div class="setting-text">
                            <span class="setting-name">–¢—ë–º–Ω–∞—è —Ç–µ–º–∞</span>
                            <span class="setting-desc">–°–∫–æ—Ä–æ –ø–æ—è–≤–∏—Ç—Å—è</span>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" disabled>
                        <span class="toggle-slider disabled"></span>
                    </label>
                </div>
            </div>
        </div>
        
        <!-- Account Info Card -->
        <div class="profile-settings-card">
            <div class="profile-settings-header">
                <div class="profile-settings-icon account-icon">
                    <span>üë§</span>
                </div>
                <div class="profile-settings-title">
                    <h3>–ê–∫–∫–∞—É–Ω—Ç</h3>
                    <p>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—á—ë—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏</p>
                </div>
            </div>
            
            <div class="account-info-list">
                <div class="account-info-item">
                    <span class="account-info-label">ID —É—á–µ–Ω–∏–∫–∞</span>
                    <span class="account-info-value">#{{ current_user.id }}</span>
                </div>
                <div class="account-info-item">
                    <span class="account-info-label">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</span>
                    <span class="account-info-value">{{ current_user.created_at.strftime('%d.%m.%Y') }}</span>
                </div>
                <div class="account-info-item">
                    <span class="account-info-label">–°—Ç–∞—Ç—É—Å</span>
                    <span class="account-status active">–ê–∫—Ç–∏–≤–µ–Ω</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Profile Modal -->
<div id="edit-profile-modal" class="modal-overlay hidden">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h3>
            <button onclick="closeModal('edit-profile-modal')" class="modal-close">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">–§–ò–û</label>
                <input type="text" id="edit-name" class="form-input" value="{{ current_user.name }}">
            </div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="edit-email" class="form-input" value="{{ current_user.email }}">
            </div>
            <div class="form-group">
                <label class="form-label">–ö–ª–∞—Å—Å</label>
                <select id="edit-class" class="form-select">
                    {% for grade in range(5, 12) %}
                    <option value="{{ grade }}–ê" {% if current_user.student_class == grade|string + '–ê' %}selected{% endif %}>{{ grade }}–ê</option>
                    <option value="{{ grade }}–ë" {% if current_user.student_class == grade|string + '–ë' %}selected{% endif %}>{{ grade }}–ë</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å)</label>
                <input type="password" id="edit-password" class="form-input" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
            </div>
            <div class="modal-actions">
                <button onclick="closeModal('edit-profile-modal')" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                <button onclick="saveProfile()" class="btn btn-primary">
                    <span>‚úì</span> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let userAllergies = {{ user_allergies | tojson }};

function toggleAllergen(allergen) {
    const index = userAllergies.indexOf(allergen);
    if (index > -1) {
        userAllergies.splice(index, 1);
    } else {
        userAllergies.push(allergen);
    }
    
    // Update UI
    document.querySelectorAll('.allergen-chip').forEach(btn => {
        const a = btn.dataset.allergen;
        if (userAllergies.includes(a)) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
    
    // Update counter
    document.querySelector('.allergen-hint strong').textContent = userAllergies.length;
    
    // Save to server
    fetch('/api/allergies', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ allergies: userAllergies })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–ª–ª–µ—Ä–≥–∏–π –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
        }
    });
}

// Profile editing
function openEditProfileModal() {
    openModal('edit-profile-modal');
}

function saveProfile() {
    const name = document.getElementById('edit-name').value;
    const email = document.getElementById('edit-email').value;
    const studentClass = document.getElementById('edit-class').value;
    const password = document.getElementById('edit-password').value;
    
    if (!name || !email) {
        showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
        return;
    }
    
    const data = {
        name: name,
        email: email,
        student_class: studentClass
    };
    
    if (password) {
        if (password.length < 6) {
            showToast('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
            return;
        }
        data.password = password;
    }
    
    fetch('/api/profile/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            closeModal('edit-profile-modal');
            setTimeout(() => location.reload(), 500);
        } else {
            showToast(data.message, 'error');
        }
    });
}
</script>
{% endblock %}
